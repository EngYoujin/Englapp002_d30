<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DUO 3.0 Helper v1.6 — TEMPLATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .flashcard { perspective: 1000px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db; }
        .flashcard-front { background-color: white; }
        .flashcard-back { background-color: #f0f9ff; transform: rotateY(180deg); }
        .speaker-btn { position: absolute; top: 10px; right: 10px; color: #6b7280; background: transparent; border: 0; cursor: pointer; }
        .speaker-btn:hover { color: #3b82f6; }
        .segment { display: inline-flex; border: 1px solid #d1d5db; border-radius: 9999px; overflow: hidden; }
        .segment button { border: 0; background-color: white; padding: 0.5rem 0.75rem; font-size: 0.875rem; cursor: pointer; min-height: 36px; transition: background-color 0.2s, color 0.2s; }
        .segment button.on { background-color: #1f2937; color: white; }
    </style>
</head>
<body class="bg-gray-100 pt-20 pb-8 min-h-screen">

    <header class="bg-white border-b fixed top-0 left-0 right-0 z-50 shadow-sm">
        <div class="max-w-4xl mx-auto p-3 flex justify-between items-center">
            <h1 id="header-title" class="text-lg font-bold text-gray-800">DUO 3.0 Helper</h1>
            <div class="flex items-center gap-4 text-sm">
                <a href="#/" id="header-toc-link" class="text-gray-600 hover:text-blue-500">目次</a>
                <a href="D3.0-review.html" id="header-review-link" class="text-gray-600 hover:text-blue-500 relative">
                    今日の復習
                    <span id="header-review-badge" class="absolute -top-2 -right-3 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden"></span>
                </a>
                <button id="reset-data-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1 px-3 border border-gray-300 rounded-full">
                    リセット
                </button>
            </div>
        </div>
    </header>

    <main id="app" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 mt-4">
        <p class="muted">読み込み中…</p>
    </main>

<!-- ▼ 3. データブロックを編集 ▼ -->
<!-- id="u01", "u02" ... のように、他ファイルと重複しない一意のIDを指定してください -->
<script id="unit-data" type="application/json">{
 "unit":"u05","title":"例文041–050",
 "sentences":[
  {
   "id":"u05-s01","number":"041",
   "mcq":{"target":"runs","stem_en":"My uncle is a farmer who also [____] a small grocery store on the side.","answer":"runs","distractors":["walks","visits","owns"]},
   "ja":"僕の叔父さんは農家なんだけど、副業で小さな食料品店も経営してるんだ。",
   "tips":[{"type":"paraphrase","en":"on the side","ja":"副業として、内緒で"}],
   "headwords":[
    {"en":"as well as", "ja":"～だけでなく"},
    {"en":"cultivate", "ja":"栽培する", "pos":"v"},
    {"en":"grain", "ja":"穀物", "pos":"n"},
    {"en":"farmer", "ja":"農家", "pos":"n"},
    {"en":"grocery store", "ja":"食料品店", "pos":"n"}
   ]
  },
  {
   "id":"u05-s02","number":"042",
   "mcq":{"target":"established","stem_en":"This coffee shop was [____] in the late 1960s and is still popular with locals.","answer":"established","distractors":["discovered","invented","constructed"]},
   "ja":"この喫茶店は1960年代後半にできて、今でも地元の人に人気なんだ。",
   "tips":[{"type":"pitfall","en":"'s in 1960s","ja":"1960sのように年代に 's がつくと「～年代」という意味を表します。"}],
   "headwords":[
    {"en":"research", "ja":"研究、調査", "pos":"n"},
    {"en":"institute", "ja":"研究所、協会", "pos":"n"}
   ]
  },
  {
   "id":"u05-s03","number":"043",
   "mcq":{"target":"consult","stem_en":"If you're unsure about the contract, you should [____] an attorney.","answer":"consult","distractors":["contact","confront","confess"]},
   "ja":"もし契約に不安があるなら、弁護士に相談すべきだよ。",
   "tips":[{"type":"paraphrase","en":"Why don't you...? = You should...","ja":"～してはどうですか"}],
   "headwords":[
    {"en":"Why don't you...?", "ja":"～してはどうですか"},
    {"en":"in person", "ja":"本人に直接会って"},
    {"en":"attorney", "ja":"弁護士", "pos":"n"},
    {"en":"by far", "ja":"はるかに、間違いなく"},
    {"en":"prominent", "ja":"傑出した、著名な", "pos":"adj"}
   ]
  },
  {
   "id":"u05-s04","number":"044",
   "mcq":{"target":"write it down","stem_en":"That's a great idea! I'll [____] before I forget it.","answer":"write it down","distractors":["remember it","say it loud","think it over"]},
   "ja":"それ、良いアイデアだね！忘れる前に書き留めておくよ。",
   "tips":[{"type":"synonym","en":"just in case = to be safe","ja":"念のため"}],
   "headwords":[
    {"en":"just in case", "ja":"念のため"},
    {"en":"have a bad memory", "ja":"記憶力が悪い"}
   ]
  },
  {
   "id":"u05-s05","number":"045",
   "mcq":{"target":"recommended","stem_en":"My client [____] I get insurance, so I'm thinking about it.","answer":"recommended","distractors":["requested","ordered","demanded"]},
   "ja":"クライアントが保険に入ることを勧めてくれたので、検討しているところです。",
   "tips":[{"type":"synonym","en":"take legal action = sue","ja":"法的措置をとる"}],
   "headwords":[
    {"en":"take legal action", "ja":"法的措置をとる"},
    {"en":"insurance", "ja":"保険", "pos":"n"},
    {"en":"client", "ja":"依頼人、顧客", "pos":"n"}
   ]
  },
  {
   "id":"u05-s06","number":"046",
   "mcq":{"target":"entitled","stem_en":"All employees are [____] to take paid leave for their injury.","answer":"entitled","distractors":["expected","excited","entered"]},
   "ja":"全従業員は、怪我のために有給休暇を取得する権利があります。",
   "tips":[{"type":"synonym","en":"compensate for = make up for","ja":"～を補償する"}],
   "headwords":[
    {"en":"compensate for", "ja":"～を補償する"},
    {"en":"injury", "ja":"怪我、負傷", "pos":"n"}
   ]
  },
  {
   "id":"u05-s07","number":"047",
   "mcq":{"target":"epidemic","stem_en":"So far, the city has managed to contain the flu [____] with everyone's cooperation.","answer":"epidemic","distractors":["parade","festival","conference"]},
   "ja":"今のところ、市は皆の協力でインフルエンザの流行を食い止めることができています。",
   "tips":[
    {"type":"paraphrase","en":"so far = until now","ja":"現在までに"},
    {"type":"pitfall", "en":"Epidemic vs. Pandemic", "ja":"Epidemicは特定の地域・国での流行、Pandemicは国境を越えた世界的な大流行を指します。"}
   ],
   "headwords":[
    {"en":"no less than", "ja":"～もの（多くの）"},
    {"en":"die of", "ja":"～で死ぬ"},
    {"en":"flu", "ja":"インフルエンザ", "pos":"n"},
    {"en":"so far", "ja":"今のところ"}
   ]
  },
  {
   "id":"u05-s08","number":"048",
   "mcq":{"target":"effect","stem_en":"I took the pill, but the [____] was so brief I barely noticed it.","answer":"effect","distractors":["affect","effort","defect"]},
   "ja":"その錠剤を飲んだけど、効果が短すぎてほとんど気づかなかったよ。",
   "tips":[{"type":"antonym","en":"intense ↔ mild","ja":"強烈な ↔ 穏やかな"}],
   "headwords":[
    {"en":"intense", "ja":"強烈な", "pos":"adj"},
    {"en":"pill", "ja":"錠剤", "pos":"n"},
    {"en":"brief", "ja":"短時間の", "pos":"adj"}
   ]
  },
  {
   "id":"u05-s09","number":"049",
   "mcq":{"target":"habit","stem_en":"My worst [____] is checking my phone right after waking up. It's absolutely disgusting.","answer":"habit","distractors":["hobby","talent","problem"]},
   "ja":"私の最悪な癖は、起きてすぐにスマホをチェックすること。本当に嫌になるよ。",
   "tips":[{"type":"synonym","en":"disgusting = unpleasant","ja":"不快な"}],
   "headwords":[
    {"en":"bite one's nails", "ja":"爪を噛む"},
    {"en":"disgusting", "ja":"不快な、うんざりさせる", "pos":"adj"},
    {"en":"absolutely", "ja":"完全に、全く", "pos":"adv"}
   ]
  },
  {
   "id":"u05-s10","number":"050",
   "mcq":{"target":"strained","stem_en":"I think I [____] my back a little when I was moving the furniture.","answer":"strained","distractors":["stretched","strengthened","scratched"]},
   "ja":"家具を動かしていた時、ちょっと腰を痛めちゃったみたい。",
   "tips":[
    {"type":"synonym","en":"bend down = stoop","ja":"かがむ"},
    {"type":"pitfall", "en":"back = 腰", "ja":"英語の back は背中全体を指しますが、文脈によっては「腰」の意味で使われることが非常に多いです（例：I have a bad back. / 腰痛持ちです）。"}
   ],
   "headwords":[
    {"en":"grandma", "ja":"おばあちゃん", "pos":"n"},
    {"en":"bend down", "ja":"かがむ"},
    {"en":"hug", "ja":"抱きしめる", "pos":"v"}
   ]
  }
 ]
}</script>
    <script>
    // ====== アプリケーションの主要ロジック ======
    // Copyright 2024, all rights reserved.
    /* ====== 永続化キー ====== */
    const KEY='duo3_progress_v1';
    const MODE_KEY='duo3_mode';
    const ORI_KEY='duo3_ori_unified';
    const HINT_CARDS='duo3_hint_cards_unified';
    const VOICE_MODE='duo3_voice_mode_unified';

    let reviewQueue = [];
    let reviewIndex = 0;

    /* ====== ユーティリティ & SRS ====== */
    function getMode(){return localStorage.getItem(MODE_KEY)||'standard';}
    function setMode(v){localStorage.setItem(MODE_KEY,v);}
    function loadProgress(){try{return JSON.parse(localStorage.getItem(KEY))||{cards:{}}}catch(e){return{cards:{}}}}
    function saveProgress(p){localStorage.setItem(KEY,JSON.stringify(p));}
    function isDue(c){return !c||!c.next_due||Date.now()>=c.next_due;}
    function tomorrowPlusDays(n=0){const d=new Date();const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1);return t.getTime()+n*86400000;}
    function markWrong(id){const p=loadProgress();const c=p.cards[id]??={};c.last_result='wrong';c.interval=0;c.next_due=Date.now()-1;p.cards[id]=c;saveProgress(p);}
    function markCorrect(id){const p=loadProgress();const c=p.cards[id]??={};c.last_result='correct';const iv=c.interval||0;const next=iv===0?1:iv===1?3:Math.min(iv*2,30);c.interval=next;c.next_due=tomorrowPlusDays(next);c.done=true;p.cards[id]=c;saveProgress(p);}
    const DATA_JSON = JSON.parse(document.getElementById('unit-data').textContent);
    const DATA = { [DATA_JSON.unit]: DATA_JSON };


    /* ====== マスク（ヒント） ====== */
    function maskWordSegment(seg){if(seg.length<=1)return seg;return seg[0]+'•'.repeat(seg.length-1);}
    function maskToken(token){let out='',buf='';const flush=()=>{if(buf){out+=maskWordSegment(buf);buf='';}};for(const ch of token){if(/[A-Za-z0-9]/.test(ch)){buf+=ch}else{flush();out+=ch}}flush();return out;}
    function maskPhrase(s){return s.split(' ').map(maskToken).join(' ');}

    /* ====== 向き・ヒント ====== */
    function getOri(){return localStorage.getItem(ORI_KEY)||'en2ja'}
    function setOri(v){localStorage.setItem(ORI_KEY,v)}
    function getHintPref(){ return (localStorage.getItem(HINT_CARDS) || 'on') === 'on'; }
    function setHintPref(on){ localStorage.setItem(HINT_CARDS, on ? 'on' : 'off'); }

    /* ====== TTS（音声合成） ====== */
    const PAUSE_MS = 1000;
    let speechSynthesis = window.speechSynthesis;
    let voiceCache = { male: null, female: null, auto: [], toggle: 0 };

    function pickVoices() {
        try {
            const vs = speechSynthesis.getVoices();
            if (!vs.length) return;
            const en = vs.filter(v => /^en([-_]|$)/i.test(v.lang) || /english/i.test(v.name));
            voiceCache.female = en.find(v => /female|jenny|ariel|emma|olivia|zira|samantha|alloy|nova/i.test(v.name)) || null;
            voiceCache.male = en.find(v => /male|david|guy|ryan|brian|matthew|daniel|andrew|roger/i.test(v.name)) || null;
            const autoVoiceSet = new Set();
            if (voiceCache.male) autoVoiceSet.add(voiceCache.male);
            if (voiceCache.female) autoVoiceSet.add(voiceCache.female);
            const usUkVoices = en.filter(v => v.lang.startsWith('en-US') || v.lang.startsWith('en-GB'));
            usUkVoices.forEach(v => autoVoiceSet.add(v));
            const otherVoices = en.filter(v => !v.lang.startsWith('en-US') && !v.lang.startsWith('en-GB'));
            otherVoices.forEach(v => autoVoiceSet.add(v));
            voiceCache.auto = Array.from(autoVoiceSet).sort(() => 0.5 - Math.random());
            if (!voiceCache.male) voiceCache.male = voiceCache.auto[0] || en[0] || vs[0];
            if (!voiceCache.female) voiceCache.female = voiceCache.auto[1] || voiceCache.auto[0] || en[0] || vs[0];
        } catch (e) { console.error('Error picking voices', e); }
    }

    if('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = pickVoices;
      pickVoices();
    }

    function sanitizeForTTS(s){
        if (!s) return s;
        let t = s.replace(/\([^)]*\)/g, '').replace(/（[^）]*）/g, '');
        t = t.replace(/<[^>]+>/g, '');
        t = t.replace(/[↔↮→—–…\/｜≠=]/g, ' [[PAUSE]] ');
        t = t.replace(/(\s*\[\[PAUSE\]\]\s*){2,}/g, ' [[PAUSE]] ');
        t = t.replace(/[\u3040-\u30FF\u3400-\u9FFF\uF900-\uFAFF]/g, '');
        t = t.replace(/\s{2,}/g, ' ').trim();
        return t;
    }

    function getVoiceMode(){return localStorage.getItem(VOICE_MODE)||'auto'}

    function speak(text){
        if (!('speechSynthesis' in window) || !text) return;
        try { speechSynthesis.cancel(); } catch (e) { }
        const prepared = sanitizeForTTS(text);
        const parts = prepared.split(/\s*\[\[PAUSE\]\]\s*/).map(s => s.trim()).filter(Boolean);
        if (parts.length === 0) return;
        const rate = parseFloat(document.getElementById('rate')?.value || '1');
        const mode = getVoiceMode();
        const pickVoiceForPart = () => {
            let voiceToUse = null;
            if (mode === 'male') { voiceToUse = voiceCache.male; }
            else if (mode === 'female') { voiceToUse = voiceCache.female; }
            else {
                if (voiceCache.auto.length > 0) {
                    voiceCache.toggle = (voiceCache.toggle + 1) % voiceCache.auto.length;
                    voiceToUse = voiceCache.auto[voiceCache.toggle];
                }
            }
            if (!voiceToUse) {
                const allVoices = speechSynthesis.getVoices();
                voiceToUse = allVoices.find(v => v.lang.startsWith('en')) || allVoices[0];
            }
            return voiceToUse;
        };
        let partIndex = 0;
        const speakNextPart = () => {
            if (partIndex >= parts.length) return;
            const u = new SpeechSynthesisUtterance(parts[partIndex]);
            u.lang = 'en-US';
            u.rate = rate;
            u.voice = pickVoiceForPart();
            u.onend = () => {
                partIndex++;
                if (partIndex < parts.length) { setTimeout(speakNextPart, PAUSE_MS); }
            };
            if (speechSynthesis.getVoices().length === 0) { setTimeout(() => speechSynthesis.speak(u), 250); }
            else { speechSynthesis.speak(u); }
        };
        speakNextPart();
    }

    /* ====== UI 同期 ====== */
    function syncAppSettings(){
        const voiceSeg=document.getElementById('voiceSeg');
        if(voiceSeg) [...voiceSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('on',b.dataset.v===getVoiceMode()));
        
        const modeSeg=document.getElementById('modeSeg');
        if(modeSeg) [...modeSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('on',b.dataset.v===getMode()));

        const oriSeg=document.getElementById('oriSeg');
        if(oriSeg) [...oriSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('on',b.dataset.v===getOri()));

        const hintSeg=document.getElementById('hintSeg');
        if(hintSeg) {
            const isHintDisabled = getOri() === 'en2ja';
            hintSeg.style.opacity = isHintDisabled ? '0.5' : '1';
            [...hintSeg.querySelectorAll('button')].forEach(b => {
                b.classList.toggle('on', (b.dataset.v === 'on') === getHintPref());
                b.disabled = isHintDisabled;
            });
        }
    }

    /* ====== ルーティング & 画面描画 ====== */
    const app=document.getElementById('app');
    addEventListener('hashchange',route);
    addEventListener('DOMContentLoaded',route);

    function route(){
      const h=location.hash||'#/';
      if(h==='#/'||h==='#'){ renderHome(); }
      else if (h === '#/final-check') { renderFinalCheck(); }
      else if (h === '#/review') { renderReview(); }
      else if(h.startsWith('#play=')){
          const s=h.slice(6);
          const[unit,qs]=s.split('?');
          const params=new URLSearchParams(qs||'');
          const i=parseInt(params.get('i')||'0',10)||0;
          const step=params.get('step')||'quiz';
          renderPlay(unit,i,step);
      }
      else { renderHome(); }
    }

    /* ====== ヘッダー ====== */
    document.getElementById('reset-data-btn').onclick=()=>{if(confirm('本当に学習データをすべてリセットしますか？')){localStorage.removeItem(KEY);alert('学習データを削除しました。');location.reload();}}
    document.getElementById('header-review-link').onclick = (e) => {
        e.preventDefault();
        location.hash = '#/review';
    }

    function getDueBreakdown(){
      const p=loadProgress();let total=0,urgent=0,scheduled=0,mcq=0,voc=0;
      for(const id in p.cards){
          const c=p.cards[id];
          if(isDue(c)){
              total++;
              if(c.last_result==='wrong') urgent++; else scheduled++;
              if (id.endsWith('-mcq')) mcq++; else voc++;
          }
      }
      return {total,urgent,scheduled,mcq,voc};
    }

    function renderHome(){
      const unitId = DATA_JSON.unit;
      const unitTitle = DATA_JSON.title;
      document.getElementById('header-title').textContent = `DUO 3.0 Helper — ${unitTitle}`;
      const unit=DATA[unitId];
      
      app.innerHTML=`
        <div id="toc-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-2">${unit.title}</h1>
            <p class="text-gray-600 text-center mb-6">学習したい例文を選ぶか、最初から全ての問題に挑戦しましょう。</p>
            <div id="review-banner-container" class="mb-6"></div>
            <div class="flex justify-center items-center gap-x-6 gap-y-4 flex-wrap mb-6 text-sm text-gray-600 border bg-gray-50 p-4 rounded-lg">
                <span class="flex items-center"><i class="fas fa-sliders-h mr-2 text-gray-500"></i><strong>音声・表示設定</strong></span>
                <span>速度: <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1" class="align-middle w-24"></span>
                <span class="flex items-center">声:
                    <span class="segment ml-2" id="voiceSeg">
                        <button data-v="auto" class="on">自動</button> <button data-v="male">男</button> <button data-v="female">女</button>
                    </span>
                </span>
                <span class="flex items-center">モード:
                    <span class="segment ml-2" id="modeSeg">
                        <button data-v="standard" class="on">標準</button> <button data-v="lite">簡易</button>
                    </span>
                </span>
                <span class="flex items-center">カード向き:
                    <span class="segment ml-2" id="oriSeg">
                        <button data-v="en2ja" class="on">英→日</button> <button data-v="ja2en">日→英</button>
                    </span>
                </span>
                <span class="flex items-center">ヒント(日→英):
                    <span class="segment ml-2" id="hintSeg">
                        <button data-v="on" class="on">ON</button> <button data-v="off">OFF</button>
                    </span>
                </span>
            </div>

            <!-- メイン学習カード -->
            <div class="bg-orange-50 border-2 border-orange-100 p-8 rounded-3xl mb-8 shadow-lg">
                <h2 class="text-3xl font-extrabold text-orange-900/80 text-center mb-6">メイン学習</h2>
                
                <button id="startAll" class="w-full bg-gradient-to-b from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-8 rounded-full text-xl transition-all transform hover:scale-105 shadow-md hover:shadow-lg mb-8">
                    最初から順番に全ての問題をやる
                </button>
                
                <h3 class="text-xl font-bold text-gray-700 text-center mb-5">個別学習・復習</h3>
                <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5"></div>
            </div>

            <!-- 腕試しカード -->
            <div class="bg-white/60 backdrop-blur-sm border border-gray-200/80 p-8 rounded-3xl shadow-lg">
                 <h2 class="text-3xl font-extrabold text-gray-800 text-center mb-6">腕試し</h2>
                 <button id="final-check-btn" class="w-full bg-white hover:bg-gray-50 text-gray-800 font-bold py-3 px-6 border-2 border-gray-300 rounded-full transition-all transform hover:scale-105">
                    まとめて最終チェック
                </button>
            </div>
        </div>`;

      document.getElementById('startAll').onclick=()=>location.hash=`#play=${unitId}?i=0&step=quiz`;
      document.getElementById('final-check-btn').onclick = () => location.hash = '#/final-check';
      
      const settingsChanged = (e, setter) => {
        const v = e.target?.dataset?.v;
        if (v) { setter(v); syncAppSettings(); }
      };
      
      document.getElementById('voiceSeg').addEventListener('click', (e) => { const v = e.target?.dataset?.v; if(v) { localStorage.setItem(VOICE_MODE, v); syncAppSettings(); }});
      document.getElementById('modeSeg').addEventListener('click', (e) => settingsChanged(e, setMode));
      document.getElementById('oriSeg').addEventListener('click', (e) => settingsChanged(e, setOri));
      document.getElementById('hintSeg').addEventListener('click', (e) => { const v = e.target?.dataset?.v; if(v) { setHintPref(v === 'on'); syncAppSettings(); }});

      const breakdown = getDueBreakdown();
      const reviewBannerContainer = document.getElementById('review-banner-container');
      const headerReviewBadge = document.getElementById('header-review-badge');

      if (breakdown.total > 0) {
          reviewBannerContainer.innerHTML = `
              <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg cursor-pointer hover:bg-yellow-200" id="start-review-btn">
                  <p class="font-bold">今日の復習があります！</p>
                  <p>期限が来たカードが <span class="font-bold">${breakdown.total}</span> 件あります。（要復習: ${breakdown.urgent}件 / 再確認: ${breakdown.scheduled}件）</p>
              </div>
          `;
          reviewBannerContainer.querySelector('#start-review-btn').addEventListener('click', () => location.hash = '#/review');
          headerReviewBadge.textContent = breakdown.total;
          headerReviewBadge.classList.remove('hidden');
      } else {
          reviewBannerContainer.innerHTML = '';
          headerReviewBadge.classList.add('hidden');
      }


      const p=loadProgress();
      const grid=document.getElementById('grid');
      unit.sentences.forEach((s,i)=>{
        const a=document.createElement('a');
        a.href=`#play=${unitId}?i=${i}&step=quiz`;
        a.className='bg-white p-4 border border-gray-200 rounded-xl shadow-md text-center font-bold text-gray-800 hover:bg-gray-50 hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 transition-all relative flex flex-col justify-center items-center';
        
        const title = document.createElement('span');
        title.textContent=`例文 ${s.number}`;
        a.appendChild(title);

        const cardMcq = p.cards[`${s.id}-mcq`];
        const dueMcq = cardMcq && isDue(cardMcq);

        const dueVoc = (s.headwords || []).some(hw => {
            const cid = `${unit.unit}-${s.id.split('-')[1]}-${hw.en.toLowerCase().replaceAll(' ','_')}`;
            const cardVoc = p.cards[cid];
            return cardVoc && isDue(cardVoc);
        });

        if (dueMcq || dueVoc) {
            const badgeContainer = document.createElement('div');
            badgeContainer.className = 'absolute top-1 right-1 flex space-x-1';
            if (dueMcq) {
                const b = document.createElement('span');
                b.className = 'text-xs bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center font-bold';
                b.textContent = 'Q';
                badgeContainer.appendChild(b);
            }
            if (dueVoc) {
                const b = document.createElement('span');
                b.className = 'text-xs bg-sky-500 text-white rounded-full h-5 w-5 flex items-center justify-center font-bold';
                b.textContent = 'V';
                badgeContainer.appendChild(b);
            }
            a.appendChild(badgeContainer);
        }
        grid.appendChild(a);
      });
      
      syncAppSettings();
    }

    function renderFinalCheck() {
        document.getElementById('header-title').textContent = 'まとめて最終チェック';
        app.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                 <a href="#/" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>目次に戻る</a>
                 <button id="shuffle-final-check-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-random mr-2"></i>順番をシャッフル</button>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">まとめて最終チェック</h2>
            <p id="final-check-description" class="text-sm text-gray-500 text-center mb-6"></p>
            <div id="final-check-flashcards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        `;
        document.getElementById('shuffle-final-check-btn').onclick = renderFinalCheck;
        const allHeadwords = Object.values(DATA).flatMap(unit => unit.sentences.flatMap(s => s.headwords.map(hw => ({ ...hw, sentenceId: s.id, unitId: unit.unit })))).sort(() => Math.random() - 0.5);
        renderGenericFlashcards(document.getElementById('final-check-flashcards'), allHeadwords);
    }

    function getDueCards() {
        const p = loadProgress();
        const due = [];
        for (const id in p.cards) {
            if (isDue(p.cards[id])) {
                const cardData = { id, progress: p.cards[id] };
                const parts = id.split('-');
                const unitId = parts[0];
                const sentenceId = `${parts[0]}-${parts[1]}`;
                
                const unit = DATA[unitId];
                if (!unit) continue;

                const sentence = unit.sentences.find(s => s.id === sentenceId);
                if (!sentence) continue;
                
                if (id.endsWith('-mcq')) {
                    cardData.type = 'mcq';
                    cardData.mcq = sentence.mcq;
                    cardData.ja = sentence.ja;
                } else {
                    const enWord = parts.slice(2).join(' ').replaceAll('_', ' ');
                    const headword = sentence.headwords.find(hw => hw.en.toLowerCase().replace(/ /g, '_') === enWord.replace(/ /g, '_'));
                    if (headword) {
                        cardData.type = 'voc';
                        cardData.hw = headword;
                    }
                }

                if(cardData.type){
                    due.push(cardData);
                }
            }
        }
        due.sort((a, b) => {
            if (a.progress.last_result === 'wrong' && b.progress.last_result !== 'wrong') return -1;
            if (a.progress.last_result !== 'wrong' && b.progress.last_result === 'wrong') return 1;
            return (a.progress.next_due || 0) - (b.progress.next_due || 0);
        });
        return due;
    }


    function renderReview() {
        document.getElementById('header-title').textContent = '今日の復習';
        reviewQueue = getDueCards();
        reviewIndex = 0;

        app.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                 <a href="#/" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>目次に戻る</a>
                 <div id="review-progress" class="text-gray-500 font-medium"></div>
            </div>
            <div id="review-card-container"></div>
            <div id="review-complete" class="hidden text-center p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">復習完了！</h2>
                <p class="text-gray-600 mb-6">今日の復習はすべて終わりました。お疲れ様でした！</p>
                <a href="#/" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full">目次に戻る</a>
            </div>
        `;

        if (reviewQueue.length > 0) {
            renderNextReviewCard();
        } else {
            document.getElementById('review-card-container').innerHTML = `<p class="text-center text-gray-500 py-8">今日の復習項目はありません。</p>`;
            document.getElementById('review-progress').textContent = '0 / 0';
        }
    }

    function renderNextReviewCard() {
        if (reviewIndex >= reviewQueue.length) {
            document.getElementById('review-card-container').classList.add('hidden');
            document.getElementById('review-complete').classList.remove('hidden');
            document.getElementById('review-progress').textContent = `完了 (${reviewQueue.length}/${reviewQueue.length})`;
            return;
        }
        
        document.getElementById('review-progress').textContent = `進捗: ${reviewIndex + 1} / ${reviewQueue.length}`;
        
        const cardData = reviewQueue[reviewIndex];
        const container = document.getElementById('review-card-container');
        container.innerHTML = ''; // Clear previous card

        if (cardData.type === 'mcq') {
            renderReviewMcqCard(container, cardData);
        } else if (cardData.type === 'voc') {
            renderReviewVocCard(container, cardData);
        } else {
            // Skip unknown card types
            reviewIndex++;
            renderNextReviewCard();
        }
    }

    function handleReviewAction(isCorrect) {
        const cardData = reviewQueue[reviewIndex];
        if (isCorrect) {
            markCorrect(cardData.id);
        } else {
            markWrong(cardData.id);
        }
        reviewIndex++;
        setTimeout(renderNextReviewCard, isCorrect ? 400 : 800);
    }

    function renderReviewMcqCard(container, cardData) {
        const { mcq, ja } = cardData;
        const shuffledChoices = [mcq.answer, ...mcq.distractors].sort(() => Math.random() - 0.5);
        let optionsHTML = shuffledChoices.map(choice =>
            `<button class="btn-option w-full p-4 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium transition-all duration-200 hover:border-blue-500 hover:shadow-md">${choice}</button>`
        ).join('');

        container.innerHTML = `
            <div class="p-4 border rounded-lg shadow-sm">
                <p class="text-sm text-gray-500 text-center mb-4">空所補充</p>
                <div class="mb-6 relative">
                    <p class="text-xl md:text-2xl text-gray-800 text-center p-4 bg-gray-50 rounded-lg">${mcq.stem_en}</p>
                    <button class="absolute top-2 right-2 text-gray-500 hover:text-blue-500 text-lg" onclick="speak('${mcq.stem_en.replace('[____]', mcq.answer).replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
                </div>
                <div id="review-quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHTML}</div>
                <div id="review-quiz-feedback" class="p-4 rounded-lg text-center font-medium hidden my-4"></div>
            </div>
        `;

        container.querySelector('#review-quiz-options').addEventListener('click', e => {
            if (e.target.tagName !== 'BUTTON' || e.target.disabled) return;
            
            const selectedButton = e.target;
            const isCorrect = selectedButton.textContent === mcq.answer;
            
            container.querySelectorAll('#review-quiz-options button').forEach(button => {
                button.disabled = true;
                if (button.textContent === mcq.answer) button.classList.add('bg-green-200', 'border-green-500');
                else if (button === selectedButton) button.classList.add('bg-red-200', 'border-red-500');
            });
            
            const feedbackEl = container.querySelector('#review-quiz-feedback');
            feedbackEl.innerHTML = isCorrect ? `<span class="font-bold text-green-700">正解！</span>` : `<span class="font-bold text-red-700">不正解。</span> 正解は <b>${mcq.answer}</b> です。`;
            feedbackEl.innerHTML += `<p class="text-gray-600 mt-2">訳：${ja}</p>`;
            feedbackEl.className = `p-4 rounded-lg text-center font-medium my-4 ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`;
            feedbackEl.classList.remove('hidden');

            handleReviewAction(isCorrect);
        });
    }

    function renderReviewVocCard(container, cardData) {
        const { hw, id } = cardData;
        const ori = getOri();
        const hintOn = getHintPref();

        const frontMain = (ori === 'en2ja') ? hw.en : hw.ja;
        const frontSub = (ori === 'en2ja') ? (hw.pos || '') : (hintOn ? `ヒント: ${maskPhrase(hw.en)}` : '');
        const backMain = (ori === 'en2ja') ? hw.ja : `${hw.en}${hw.pos ? ` <small class="text-base text-gray-500">/ ${hw.pos}</small>` : ''}`;
        
        container.innerHTML = `
            <div class="card-wrapper flex flex-col gap-2">
                <div class="flashcard h-48 relative">
                    <div class="flashcard-inner">
                        <div class="flashcard-front"><div class="text-center">
                            <strong class="text-2xl font-bold text-gray-800">${frontMain}</strong>
                            ${frontSub ? `<br><small class="text-gray-500 mt-1">${frontSub}</small>` : ''}
                        </div><button class="speaker-btn" onclick="event.stopPropagation(); speak('${hw.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button></div>
                        <div class="flashcard-back"><div class="text-center">
                            <strong class="text-2xl font-bold text-gray-800">${backMain}</strong>
                        </div><button class="speaker-btn" onclick="event.stopPropagation(); speak('${hw.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button></div>
                    </div>
                </div>
                <div id="review-voc-actions" class="grid grid-cols-2 gap-2 hidden mt-2">
                    <button data-action="mark-wrong" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">あとで復習</button>
                    <button data-action="mark-correct" class="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">できた</button>
                </div>
            </div>
        `;

        const flashcard = container.querySelector('.flashcard');
        const actions = container.querySelector('#review-voc-actions');

        flashcard.addEventListener('click', () => {
            if (flashcard.classList.contains('flipped')) return;
            flashcard.classList.add('flipped');
            actions.classList.remove('hidden');
        });

        actions.addEventListener('click', e => {
            const action = e.target.closest('[data-action]')?.dataset.action;
            if (!action) return;
            
            if (action === 'mark-correct') {
                handleReviewAction(true);
            } else if (action === 'mark-wrong') {
                handleReviewAction(false);
            }
        });
    }

    function renderGenericFlashcards(container, cards) {
        container.innerHTML = '';
        const progress = loadProgress();
        const ori = getOri();
        const hintOn = getHintPref();
        cards.forEach(card => {
            const cid = `${card.unitId}-${card.sentenceId.split('-')[1]}-${card.en.toLowerCase().replaceAll(' ','_')}`;
            const cardProgress = progress.cards[cid];
            const cardEl = document.createElement('div');
            cardEl.className = 'flex flex-col gap-2';
            const flashcardDiv = document.createElement('div');
            flashcardDiv.className = 'flashcard h-48 relative'; 
            let statusBadgeHTML = '';
            if (cardProgress && isDue(cardProgress) && cardProgress.last_result === 'wrong') { statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full z-10">要復習</span>'; }
            else if (cardProgress && isDue(cardProgress)) { statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full z-10">再確認</span>'; }
            else if (cardProgress && cardProgress.done) { statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full z-10">できた</span>'; }
            const frontMain = (ori === 'en2ja') ? card.en : card.ja;
            const frontSub = (ori === 'en2ja') ? (card.pos || '') : (hintOn ? `ヒント: ${maskPhrase(card.en)}` : '');
            const backMain = (ori === 'en2ja') ? card.ja : `${card.en}${card.pos ? ` / <small>${card.pos}</small>` : ''}`;
            flashcardDiv.innerHTML = `${statusBadgeHTML}<div class="flashcard-inner" style="min-height: 120px;"><div class="flashcard-front text-center"><strong class="text-2xl">${frontMain}</strong>${frontSub ? `<br><small class="text-gray-500">${frontSub}</small>`: ''}<button class="speaker-btn"><i class="fas fa-volume-up"></i></button></div><div class="flashcard-back text-center"><strong class="text-2xl">${backMain}</strong><button class="speaker-btn"><i class="fas fa-volume-up"></i></button></div></div>`;
            flashcardDiv.addEventListener('click', () => flashcardDiv.classList.toggle('flipped'));
            flashcardDiv.querySelectorAll('.speaker-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); speak(card.en); }); });
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'grid grid-cols-2 gap-2';
            const correctBtn = document.createElement('button');
            correctBtn.textContent = 'できた';
            correctBtn.className = 'w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors';
            correctBtn.onclick = (e) => { e.stopPropagation(); markCorrect(cid); renderGenericFlashcards(container, cards); };
            const wrongBtn = document.createElement('button');
            wrongBtn.textContent = 'あとで復習';
            wrongBtn.className = 'w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors';
            wrongBtn.onclick = (e) => { e.stopPropagation(); markWrong(cid); renderGenericFlashcards(container, cards); };
            buttonContainer.append(wrongBtn, correctBtn);
            cardEl.append(flashcardDiv, buttonContainer);
            container.appendChild(cardEl);
        });
    }

    function svg(name){
      const e = {'collocation':'<span class="tip-emoji">🔗</span>','paraphrase':'<span class="tip-emoji">🔁</span>','synonym':'<span class="tip-emoji">≈</span>','antonym':'<span class="tip-emoji">⇄</span>','usage':'<span class="tip-emoji">💡</span>','dialog':'<span class="tip-emoji">💬</span>'};
      return e[name]||'';
    }

    function renderPlay(unitId,idx,step){
      const unit=DATA[unitId]; const s=unit.sentences[idx]; if(!s){app.textContent='データが見つかりません。';return;}
      document.getElementById('header-title').textContent = `例文 ${s.number}`;
      app.innerHTML = `
        <div id="main-quiz-area">
            <div class="flex justify-between items-center mb-2">
                <a href="#/" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>目次に戻る</a>
                <p class="text-gray-500 font-medium">例文 ${s.number}/${unit.sentences[unit.sentences.length-1].number}</p>
            </div>
            <div class="flex justify-center space-x-1 md:space-x-2 mb-6 text-xs md:text-sm" id="step-indicators-container">
                <a href="#play=${unitId}?i=${idx}&step=quiz" data-step="quiz" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">1:クイズ</a>
                ${getMode() !== 'lite' ? `<a href="#play=${unitId}?i=${idx}&step=tips" data-step="tips" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">2:応用</a>` : ''}
                <a href="#play=${unitId}?i=${idx}&step=cards" data-step="cards" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">3:単語カード</a>
            </div>
            <div id="step-views">
                <div id="step-quiz"></div> <div id="step-tips" class="hidden"></div> <div id="step-cards" class="hidden"></div>
            </div>
            <div id="sentence-nav" class="flex justify-between mt-4 pt-4 border-t">
                <a id="prev-sentence-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-chevron-left mr-2"></i>前の例文</a>
                <a id="next-sentence-btn" class="text-blue-500 hover:text-blue-700 font-semibold">次の例文<i class="fas fa-chevron-right ml-2"></i></a>
            </div>
        </div>`;
      const prevBtn = document.getElementById('prev-sentence-btn');
      const nextBtn = document.getElementById('next-sentence-btn');
      if (idx > 0) { prevBtn.href = `#play=${unitId}?i=${idx-1}&step=quiz`; }
      else { prevBtn.classList.add('opacity-50', 'cursor-not-allowed'); prevBtn.onclick = (e) => e.preventDefault(); }
      if (idx < unit.sentences.length - 1) { nextBtn.href = `#play=${unitId}?i=${idx+1}&step=quiz`; }
      else { nextBtn.classList.add('opacity-50', 'cursor-not-allowed'); nextBtn.onclick = (e) => e.preventDefault(); }
      const stepViews = {quiz: document.getElementById('step-quiz'), tips: document.getElementById('step-tips'), cards: document.getElementById('step-cards')};
      Object.values(stepViews).forEach(v => v && v.classList.add('hidden'));
      const currentStepView = stepViews[step];
      if (currentStepView) {
          currentStepView.classList.remove('hidden');
          const activeIndicator = document.querySelector(`.step-indicator[data-step="${step}"]`);
          if(activeIndicator) activeIndicator.classList.add('bg-blue-500', 'text-white', 'font-bold');
      }
      if (step === 'quiz') renderQuiz(stepViews.quiz, unit, s, idx);
      else if (step === 'tips' && getMode() !== 'lite') renderTips(stepViews.tips, unit, s, idx);
      else if (step === 'cards') renderCards(stepViews.cards, unit, s, idx);
    }

    function renderQuiz(container, unit, sentence, idx) {
        const { mcq, ja } = sentence;
        const shuffledChoices = [mcq.answer, ...mcq.distractors].sort(() => Math.random() - 0.5);
        let optionsHTML = shuffledChoices.map(choice =>
            `<button class="btn-option w-full p-4 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium transition-all duration-200 hover:border-blue-500 hover:shadow-md">${choice}</button>`
        ).join('');
        container.innerHTML = `
            <p class="text-sm text-gray-500 text-center mb-4">あてはまる選択肢を選びましょう。</p>
            <div class="mb-6 relative">
                <p class="text-xl md:text-2xl text-gray-800 text-left p-4 bg-gray-50 rounded-lg">${mcq.stem_en}</p>
                <button class="speaker-btn text-xl" onclick="speak('${mcq.stem_en.replace('[____]', mcq.answer).replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
            </div>
            <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHTML}</div>
            <div id="quiz-feedback" class="p-4 rounded-lg text-center font-medium hidden my-4"></div>
            <div id="quiz-nav" class="text-center mt-6 hidden"></div>
        `;
        container.querySelector('#quiz-options').addEventListener('click', e => {
            if (e.target.tagName !== 'BUTTON') return;
            const selectedButton = e.target;
            const isCorrect = selectedButton.textContent === mcq.answer;
            const itemId = `${sentence.id}-mcq`;
            if (isCorrect) markCorrect(itemId); else markWrong(itemId);
            const feedbackEl = container.querySelector('#quiz-feedback');
            feedbackEl.innerHTML = isCorrect
                ? `<span class="font-bold text-green-700">正解！</span>`
                : `<span class="font-bold text-red-700">不正解。</span> 正解は <b>${mcq.answer}</b> です。`;
            feedbackEl.innerHTML += `<p class="text-gray-600 mt-2">訳：${ja}</p>`;
            feedbackEl.className = `p-4 rounded-lg text-center font-medium my-4 ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`;
            feedbackEl.classList.remove('hidden');
            container.querySelectorAll('#quiz-options button').forEach(button => {
                button.disabled = true;
                if (button.textContent === mcq.answer) button.classList.add('bg-green-200', 'border-green-500');
                else if (button === selectedButton) button.classList.add('bg-red-200', 'border-red-500');
            });
            const quizNav = container.querySelector('#quiz-nav');
            const nextStep = (getMode() !== 'lite' && sentence.tips && sentence.tips.length > 0) ? 'tips' : 'cards';
            quizNav.innerHTML = `<a href="#play=${unit.unit}?i=${idx}&step=${nextStep}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors">次へ</a>`;
            quizNav.classList.remove('hidden');
        });
    }
    function renderTips(container, unit, sentence, idx) {
        const { tips } = sentence;
        const labels={'collocation':{title:'コロケーション', icon:svg('collocation')}, 'paraphrase':{title:'言い換え', icon:svg('paraphrase')}, 'synonym':{title:'類義語', icon:svg('synonym')}, 'antonym':{title:'対義語', icon:svg('antonym')}, 'usage':{title:'用法', icon:svg('usage')}, 'dialog':{title:'会話例', icon:svg('dialog')}};
        const order=['collocation','paraphrase','synonym','antonym','usage','dialog'];
        if (!tips || tips.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500">この例文の応用はありません。</p>`;
        } else {
            const groups={}; tips.forEach(t=>{(groups[t.type]=groups[t.type]||[]).push(t);});
            let html = '';
            order.forEach(key => {
                if (!groups[key]) return;
                html += `<h4 class="text-md font-bold text-gray-700 mt-6 mb-2 flex items-center">${labels[key].icon} <span class="ml-2">${labels[key].title}</span></h4>`;
                groups[key].forEach(t => {
                    html += `
                        <div class="tip-item flex items-center p-3 border rounded-lg bg-white mb-2">
                            <div>
                                <span class="font-semibold text-gray-800">${t.en}</span><span class="text-gray-600"> — ${t.ja}</span>
                            </div>
                            <button onclick="speak('${(t.tts || t.en).replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/`/g, '\\`')}')" class="ml-auto flex-shrink-0 p-2 text-gray-400 hover:text-blue-500 text-xl"><i class="fas fa-volume-up"></i></button>
                        </div>`;
                });
            });
            container.innerHTML = html;
        }
        const quizNav = document.createElement('div');
        quizNav.className = 'text-center mt-6';
        quizNav.innerHTML = `<a href="#play=${unit.unit}?i=${idx}&step=cards" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors">単語カードへ</a>`;
        container.appendChild(quizNav);
    }
    function renderCards(container, unit, sentence, idx) {
        let topChipsHTML = `
            <div class="toprow flex items-center justify-center gap-4 mb-6 text-sm">
                <span class="chip flex items-center p-2 border rounded-full bg-gray-50">
                    向き: <b class="mx-1">${getOri() === 'en2ja' ? '英→日' : '日→英'}</b>
                    <button class="text-blue-500 ml-1 font-semibold" data-action="toggle-ori">変更</button>
                </span>`;
        if (getOri() === 'ja2en') {
            topChipsHTML += `
                <span class="chip flex items-center p-2 border rounded-full bg-gray-50">
                    ヒント: <b class="mx-1">${getHintPref() ? 'ON' : 'OFF'}</b>
                    <button class="text-blue-500 ml-1 font-semibold" data-action="toggle-hint">切替</button>
                </span>`;
        }
        topChipsHTML += '</div>';
        container.innerHTML = topChipsHTML + '<div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>';
        renderSentenceFlashcards(container.querySelector('#cards-container'), unit, sentence);
        container.addEventListener('click', e => {
            const action = e.target.dataset.action;
            if (action === 'toggle-ori') { setOri(getOri() === 'en2ja' ? 'ja2en' : 'en2ja'); route(); }
            if (action === 'toggle-hint') { setHintPref(!getHintPref()); route(); }
        });
        const navDiv = document.createElement('div');
        navDiv.className = 'text-center mt-6';
        const nextSentenceIdx = idx + 1;
        const navLink = (nextSentenceIdx < unit.sentences.length) ? `#play=${unit.unit}?i=${nextSentenceIdx}&step=quiz` : '#/';
        const navText = (nextSentenceIdx < unit.sentences.length) ? '次の例文へ' : '目次に戻る';
        navDiv.innerHTML = `<a href="${navLink}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors">${navText}</a>`;
        container.appendChild(navDiv);
    }
    function renderSentenceFlashcards(container, unit, sentence) {
        const { headwords } = sentence;
        const ori = getOri();
        const hintOn = getHintPref();
        const progress = loadProgress();
        container.innerHTML = headwords.map(hw => {
            const cid = `${unit.unit}-${sentence.id.split('-')[1]}-${hw.en.toLowerCase().replaceAll(' ','_')}`;
            const p = progress.cards[cid];
            let statusBadgeHTML = '';
            if (p && isDue(p) && p.last_result === 'wrong') statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full z-10">要復習</span>';
            else if (p && isDue(p)) statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full z-10">再確認</span>';
            else if (p && p.done) statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full z-10">できた</span>';
            const frontMain = (ori === 'en2ja') ? hw.en : hw.ja;
            const frontMainClass = (ori === 'en2ja') ? 'text-2xl' : 'text-xl';
            const backMainClass = (ori === 'en2ja') ? 'text-xl' : 'text-2xl';
            const frontSub = (ori === 'en2ja') ? (hw.pos || '') : (hintOn ? `ヒント: ${maskPhrase(hw.en)}` : '');
            const backMain = (ori === 'en2ja') ? hw.ja : `${hw.en}${hw.pos ? ` <small class="text-base text-gray-500">/ ${hw.pos}</small>` : ''}`;
            return `
                <div class="card-wrapper flex flex-col gap-2" data-cid="${cid}">
                    <div class="flashcard h-48 relative">
                        ${statusBadgeHTML}
                        <div class="flashcard-inner">
                            <div class="flashcard-front"><div class="text-center">
                                <strong class="${frontMainClass} font-bold text-gray-800">${frontMain}</strong>
                                ${frontSub ? `<br><small class="text-gray-500 mt-1">${frontSub}</small>` : ''}
                            </div><button class="speaker-btn" data-action="speak" data-text="${hw.en.replace(/'/g, "\\'")}"><i class="fas fa-volume-up"></i></button></div>
                            <div class="flashcard-back"><div class="text-center">
                                <strong class="${backMainClass} font-bold text-gray-800">${backMain}</strong>
                            </div><button class="speaker-btn" data-action="speak" data-text="${hw.en.replace(/'/g, "\\'")}"><i class="fas fa-volume-up"></i></button></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button data-action="mark-wrong" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">あとで復習</button>
                        <button data-action="mark-correct" class="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">できた</button>
                    </div>
                </div>`;
        }).join('');
        container.addEventListener('click', e => {
            const cardWrapper = e.target.closest('.card-wrapper');
            if (!cardWrapper) return;
            const action = e.target.closest('[data-action]')?.dataset.action;
            const cid = cardWrapper.dataset.cid;
            if (action === 'speak') { e.stopPropagation(); speak(e.target.closest('[data-text]').dataset.text); return; }
            if (action === 'mark-wrong') { markWrong(cid); route(); return; }
            if (action === 'mark-correct') { markCorrect(cid); route(); return; }
            const flashcard = cardWrapper.querySelector('.flashcard');
            if (flashcard) flashcard.classList.toggle('flipped');
        });
    }

    /* ====== 汎用テンプレート本体 ====== */
    (function() {
        const main = document.querySelector('main');
        if (main) {
            main.className = 'max-w-5xl mx-auto bg-transparent p-4 md:p-6 mt-4';
        }
    })();

</script>
</body>
</html>
