<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DUO 3.0 Helper v1.6 â€” TEMPLATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .flashcard { perspective: 1000px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db; }
        .flashcard-front { background-color: white; }
        .flashcard-back { background-color: #f0f9ff; transform: rotateY(180deg); }
        .speaker-btn { position: absolute; top: 10px; right: 10px; color: #6b7280; background: transparent; border: 0; cursor: pointer; }
        .speaker-btn:hover { color: #3b82f6; }
        .segment { display: inline-flex; border: 1px solid #d1d5db; border-radius: 9999px; overflow: hidden; }
        .segment button { border: 0; background-color: white; padding: 0.5rem 0.75rem; font-size: 0.875rem; cursor: pointer; min-height: 36px; transition: background-color 0.2s, color 0.2s; }
        .segment button.on { background-color: #1f2937; color: white; }
    </style>
</head>
<body class="bg-gray-100 pt-20 pb-8 min-h-screen">

    <header class="bg-white border-b fixed top-0 left-0 right-0 z-50 shadow-sm">
        <div class="max-w-4xl mx-auto p-3 flex justify-between items-center">
            <h1 id="header-title" class="text-lg font-bold text-gray-800">DUO 3.0 Helper</h1>
            <div class="flex items-center gap-4 text-sm">
                <a href="#/" id="header-toc-link" class="text-gray-600 hover:text-blue-500">ç›®æ¬¡</a>
                <a href="D3.0-review.html" id="header-review-link" class="text-gray-600 hover:text-blue-500 relative">
                    ä»Šæ—¥ã®å¾©ç¿’
                    <span id="header-review-badge" class="absolute -top-2 -right-3 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden"></span>
                </a>
                <button id="reset-data-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1 px-3 border border-gray-300 rounded-full">
                    ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </div>
    </header>

    <main id="app" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 mt-4">
        <p class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
    </main>

<!-- â–¼ 3. ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç·¨é›† â–¼ -->
<!-- id="u01", "u02" ... ã®ã‚ˆã†ã«ã€ä»–ãƒ•ã‚¡ã‚¤ãƒ«ã¨é‡è¤‡ã—ãªã„ä¸€æ„ã®IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ -->
<script id="unit-data" type="application/json">{
 "unit":"u11",
 "title":"ä¾‹æ–‡101â€“110",
 "sentences":[
  {
   "id":"u11-s01","number":"101",
   "mcq":{"target":"amaze","stem_en":"It will [____] you how high the utility bill can come to in winter.","answer":"amaze","distractors":["shock","please","bore"]},
   "ja":"å†¬ã¯å…‰ç†±è²»ã®è«‹æ±‚é¡ãŒé©šãã»ã©é«˜ããªã‚‹ã‚ˆã€‚",
   "tips":[
    {"type":"usage","en":"come to ...","ja":"ã€Œï¼ˆåˆè¨ˆãŒï¼‰ï½ã«ãªã‚‹ã€ã€‚å€¤æ®µã‚„è²»ç”¨ã®åˆè¨ˆã«ã¤ã„ã¦è©±ã™ã¨ãã«ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚"},
    {"type":"usage","en":"amaze","ja":"ã€Œï½ã‚’ï¼ˆã¨ã¦ã‚‚ï¼‰é©šã‹ã™ã€ã€‚å˜ã«é©šãã ã‘ã§ãªãã€æ„Ÿå¿ƒã—ãŸã‚Šæ„Ÿå‹•ã—ãŸã‚Šã™ã‚‹ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ãŒå«ã¾ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚"}
   ],
   "headwords":[
    {"en":"amaze", "ja":"ï½ã‚’ï¼ˆã¨ã¦ã‚‚ï¼‰é©šã‹ã™"},
    {"en":"utility", "ja":"ï¼ˆé›»æ°—ãƒ»ã‚¬ã‚¹ãƒ»æ°´é“ãªã©ã®ï¼‰å…¬ç›Šã‚µãƒ¼ãƒ“ã‚¹"},
    {"en":"bill", "ja":"è«‹æ±‚æ›¸"},
    {"en":"come to", "ja":"ï¼ˆåˆè¨ˆãŒï¼‰ï½ã«ãªã‚‹"}
   ]
  },
  {
   "id":"u11-s02","number":"102",
   "mcq":{"target":"faucet","stem_en":"Don't forget to turn off the [____] completely.","answer":"faucet","distractors":["shower","light","computer"]},
   "ja":"è›‡å£ã‚’å®Œå…¨ã«é–‰ã‚ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã§ã­ã€‚",
   "tips":[
    {"type":"usage","en":"in a rage","ja":"ã€Œã‹ã‚“ã‹ã‚“ã«ãªã£ã¦ã€ã€‚éå¸¸ã«å¼·ã„æ€’ã‚Šã‚’è¡¨ç¾ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã§ã™ã€‚"},
    {"type":"synonym","en":"turn off = switch off","ja":"ã€Œï½ã‚’æ¶ˆã™ã€ï½ã‚’æ­¢ã‚ã‚‹ã€ã€‚é›»æ°—è£½å“ã‚„æ°´é“ãªã©ã€æ§˜ã€…ãªã‚‚ã®ã«ä½¿ãˆã¾ã™ã€‚"}
   ],
   "headwords":[
    {"en":"turn ... off", "ja":"ï½ã‚’æ­¢ã‚ã‚‹"},
    {"en":"faucet", "ja":"è›‡å£"},
    {"en":"yell", "ja":"å«ã¶"},
    {"en":"rage", "ja":"æ¿€æ€’"}
   ]
  },
  {
   "id":"u11-s03","number":"103",
   "mcq":{"target":"go bad","stem_en":"This milk might [____] soon, so let's use it tonight.","answer":"go bad","distractors":["taste sweet","be perfect","get better"]},
   "ja":"ã“ã®ç‰›ä¹³ã¯ã‚‚ã†ã™ãæ‚ªããªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‹ã‚‰ã€ä»Šå¤œä½¿ã£ã¦ã—ã¾ãŠã†ã€‚",
   "tips":[
    {"type":"usage","en":"go bad","ja":"ã€Œï¼ˆé£Ÿã¹ç‰©ãŒï¼‰è…ã‚‹ã€æ‚ªããªã‚‹ã€ã€‚ç‰¹ã«é£Ÿå“ã«å¯¾ã—ã¦ä½¿ã‚ã‚Œã‚‹ä¸€èˆ¬çš„ãªè¡¨ç¾ã§ã™ã€‚"},
    {"type":"usage","en":"so that ...","ja":"ã€Œï½ã™ã‚‹ã‚ˆã†ã«ã€ã€‚ç›®çš„ã‚’è¡¨ã™æ¥ç¶šè©ã§ã™ã€‚"}
   ],
   "headwords":[
    {"en":"tighten", "ja":"ï½ã‚’ãã¤ãç· ã‚ã‚‹"},
    {"en":"lid", "ja":"è“‹"},
    {"en":"so that", "ja":"ï½ã™ã‚‹ã‚ˆã†ã«"},
    {"en":"go bad", "ja":"ï¼ˆé£Ÿã¹ç‰©ãŒï¼‰è…ã‚‹"}
   ]
  },
  {
   "id":"u11-s04","number":"104",
   "mcq":{"target":"Sure","stem_en":"'Can you help me with this heavy box?' '[____], no problem.'","answer":"Sure","distractors":["Never","Sorry","Maybe"]},
   "ja":"ã€Œã“ã®é‡ã„ç®±ã€æ‰‹ä¼ã£ã¦ãã‚Œã‚‹ï¼Ÿã€ã€Œã‚‚ã¡ã‚ã‚“ã€ã„ã„ã§ã™ã‚ˆã€‚ã€",
   "tips":[
    {"type":"usage","en":"Here you are.","ja":"ç‰©ã‚’æ‰‹æ¸¡ã™ã¨ãã®æ±ºã¾ã‚Šæ–‡-å¥ã§ã€ã€Œã¯ã„ã€ã©ã†ãã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚'Here you go.' ã‚‚åŒã˜ã‚ˆã†ã«ä½¿ãˆã¾ã™ã€‚"},
    {"type":"antonym","en":"borrow â†” lend","ja":"'borrow'ã¯ã€Œï¼ˆç„¡æ–™ã§ï¼‰å€Ÿã‚Šã‚‹ã€ã€'lend'ã¯ã€Œï¼ˆç„¡æ–™ã§ï¼‰è²¸ã™ã€ã¨åå¯¾ã®æ„å‘³ã«ãªã‚Šã¾ã™ã€‚"}
   ],
   "headwords":[
    {"en":"borrow", "ja":"ï½ã‚’ï¼ˆç„¡æ–™ã§ï¼‰å€Ÿã‚Šã‚‹"},
    {"en":"scissors", "ja":"ã¯ã•ã¿"},
    {"en":"Sure.", "ja":"ã‚‚ã¡ã‚ã‚“ã€‚"},
    {"en":"Here you are.", "ja":"ã¯ã„ã€ã©ã†ãã€‚"}
   ]
  },
  {
   "id":"u11-s05","number":"105",
   "mcq":{"target":"glue","stem_en":"I'll substitute this transparent [____] for the broken needle and thread.","answer":"glue","distractors":["tape","staple","clip"]},
   "ja":"å£Šã‚ŒãŸé‡ã¨ç³¸ã®ä»£ã‚ã‚Šã«ã€ã“ã®é€æ˜ãªæ¥ç€å‰¤ã‚’ä½¿ã„ã¾ã™ã€‚",
   "tips":[
    {"type":"usage","en":"substitute A for B","ja":"ã€ŒBã®ä»£ã‚ã‚Šã«Aã‚’ä½¿ã†ã€ã¨ã„ã†æ„å‘³ã®æ§‹æ–‡ã§ã™ã€‚"},
    {"type":"usage","en":"transparent","ja":"ã€Œé€æ˜ãªã€ã€‚ç‰©ç†çš„ã«å‘ã“ã†å´ãŒè¦‹ãˆã‚‹çŠ¶æ…‹ã ã‘ã§ãªãã€ã€Œï¼ˆæ„å›³ãªã©ãŒï¼‰è¦‹ãˆé€ã„ãŸã€ã¨ã„ã†æ„å‘³ã§æ¯”å–©çš„ã«ã‚‚ä½¿ã‚ã‚Œã¾ã™ã€‚"}
   ],
   "headwords":[
    {"en":"substitute", "ja":"ï½ã‚’ä»£ã‚ã‚Šã«ä½¿ã†"},
    {"en":"transparent", "ja":"é€æ˜ãª"},
    {"en":"glue", "ja":"æ¥ç€å‰¤"},
    {"en":"needle", "ja":"é‡"},
    {"en":"thread", "ja":"ç³¸"}
   ]
  },
  {
   "id":"u11-s06","number":"106",
   "mcq":{"target":"fabric","stem_en":"This special [____] doesn't shrink when you dye it.","answer":"fabric","distractors":["paper","plastic","metal"]},
   "ja":"ã“ã®ç‰¹æ®Šãªç”Ÿåœ°ã¯æŸ“ã‚ã¦ã‚‚ç¸®ã¾ãªã„ã‚“ã§ã™ã‚ˆã€‚",
   "tips":[
    {"type":"usage","en":"dye","ja":"ã€Œï½ã‚’æŸ“ã‚ã‚‹ã€ã€‚å¸ƒã‚„é«ªãªã©ã‚’ç‰¹å®šã®è‰²ã«å¤‰ãˆã‚‹è¡Œç‚ºã‚’æŒ‡ã—ã¾ã™ã€‚åè©ã¨ã—ã¦ã¯ã€ŒæŸ“æ–™ã€ã¨ã„ã†æ„å‘³ã‚‚ã‚ã‚Šã¾ã™ã€‚"},
    {"type":"grammar","en":"shrink - shrank - shrunk","ja":"ã€Œç¸®ã‚€ã€ã‚’æ„å‘³ã™ã‚‹å‹•è©'shrink'ã®æ´»ç”¨å½¢ã§ã™ã€‚"}
   ],
   "headwords":[
    {"en":"dye", "ja":"ï½ã‚’æŸ“ã‚ã‚‹"},
    {"en":"fabric", "ja":"ç¹”ç‰©ã€å¸ƒåœ°"},
    {"en":"shrink", "ja":"ç¸®ã‚€"}
   ]
  },
  {
   "id":"u11-s07","number":"107",
   "mcq":{"target":"worn out","stem_en":"My favorite leather shoes are getting [____] at the heels.","answer":"worn out","distractors":["brand new","polished","cleaner"]},
   "ja":"ãŠæ°—ã«å…¥ã‚Šã®é©é´ã®ã‹ã‹ã¨ãŒã™ã‚Šæ¸›ã£ã¦ããŸã€‚",
   "tips":[
    {"type":"usage","en":"worn out","ja":"ã€Œã™ã‚Šæ¸›ã£ãŸã€ä½¿ã„å¤ã•ã‚ŒãŸã€ã€‚ç‰©ã ã‘ã§ãªãã€äººãŒã€Œç–²ã‚Œæœã¦ã¦ã€ã¨ã„ã†æ„å‘³ã§ã‚‚ä½¿ã‚ã‚Œã¾ã™ã€‚"},
    {"type":"synonym","en":"get rid of = dispose of, throw away","ja":"ã€Œï½ã‚’å‡¦åˆ†ã™ã‚‹ã€æ¨ã¦ã‚‹ã€ã€‚ä¸è¦ãªã‚‚ã®ã‚’å–ã‚Šé™¤ãã¨ãã«ä½¿ã„ã¾ã™ã€‚"}
   ],
   "headwords":[
    {"en":"get rid of", "ja":"ï½ã‚’å‡¦åˆ†ã™ã‚‹"},
    {"en":"leather", "ja":"é©"},
    {"en":"wear out", "ja":"ã™ã‚Šæ¸›ã‚‹"},
    {"en":"elbow", "ja":"è‚˜"}
   ]
  },
  {
   "id":"u11-s08","number":"108",
   "mcq":{"target":"add","stem_en":"Just [____] a little flour and stir the mixture until it's thick.","answer":"add","distractors":["remove","eat","smell"]},
   "ja":"å°‘é‡ã®å°éº¦ç²‰ã‚’åŠ ãˆã¦ã€ã¨ã‚ã¿ãŒã¤ãã¾ã§æ··ãœåˆã‚ã›ãªã•ã„ã€‚",
   "tips":[
    {"type":"usage","en":"add A to B","ja":"ã€ŒBã«Aã‚’åŠ ãˆã‚‹ã€ã€‚æ–™ç†ã®ãƒ¬ã‚·ãƒ”ãªã©ã§é »ç¹ã«ä½¿ã‚ã‚Œã‚‹è¡¨ç¾ã§ã™ã€‚"},
    {"type":"usage","en":"thick","ja":"ã€Œï¼ˆæ¶²ä½“ãªã©ãŒï¼‰æ¿ƒã„ã€ã¨ã‚ã¿ã®ã‚ã‚‹ã€ã€‚ã‚¹ãƒ¼ãƒ—ã‚„ã‚½ãƒ¼ã‚¹ãªã©ã®æ¿ƒåº¦ã‚’è¡¨ã™ã®ã«ã‚ˆãä½¿ã„ã¾ã™ã€‚"}
   ],
   "headwords":[
    {"en":"add", "ja":"ï½ã‚’åŠ ãˆã‚‹"},
    {"en":"flour", "ja":"å°éº¦ç²‰"},
    {"en":"mixture", "ja":"æ··åˆç‰©"},
    {"en":"stir", "ja":"ï½ã‚’ã‹ãæ··ãœã‚‹"},
    {"en":"thick", "ja":"ï¼ˆæ¶²ä½“ãªã©ãŒï¼‰æ¿ƒã„ã€ã¨ã‚ã¿ã®ã‚ã‚‹"}
   ]
  },
  {
   "id":"u11-s09","number":"109",
   "mcq":{"target":"fridge","stem_en":"What should we do with the leftovers? Put them in the [____] for now.","answer":"fridge","distractors":["oven","pantry","trash"]},
   "ja":"æ®‹ã‚Šç‰©ã¯ã©ã†ã—ã‚ˆã†ã‹ï¼Ÿã¨ã‚Šã‚ãˆãšå†·è”µåº«ã«å…¥ã‚Œã¦ãŠã„ã¦ã€‚",
   "tips":[
    {"type":"usage","en":"for now","ja":"ã€Œã¨ã‚Šã‚ãˆãšã€ã•ã—ã‚ãŸã£ã¦ã€ã€‚ä¸€æ™‚çš„ãªæªç½®ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã¨ãã«ä½¿ã„ã¾ã™ã€‚"},
    {"type":"usage","en":"microwave","ja":"åè©ã¨ã—ã¦ã€Œé›»å­ãƒ¬ãƒ³ã‚¸ã€ã€å‹•è©ã¨ã—ã¦ã€Œé›»å­ãƒ¬ãƒ³ã‚¸ã§æ¸©ã‚ã‚‹ã€ã®ä¸¡æ–¹ã®æ„å‘³ã§ä½¿ã‚ã‚Œã¾ã™ã€‚"}
   ],
   "headwords":[
    {"en":"do with", "ja":"ï½ã‚’ã©ã†å‡¦ç†ã™ã‚‹ã‹"},
    {"en":"leftovers", "ja":"æ®‹ã‚Šç‰©"},
    {"en":"fridge", "ja":"å†·è”µåº«"},
    {"en":"for now", "ja":"ã¨ã‚Šã‚ãˆãš"},
    {"en":"microwave", "ja":"é›»å­ãƒ¬ãƒ³ã‚¸"}
   ]
  },
  {
   "id":"u11-s10","number":"110",
   "mcq":{"target":"decide","stem_en":"On second thought, I'll [____] to put some money aside.","answer":"decide","distractors":["forget","regret","hesitate"]},
   "ja":"è€ƒãˆç›´ã—ã¦ã€ã„ãã‚‰ã‹ãŠé‡‘ã‚’å–ã£ã¦ãŠãã“ã¨ã«æ±ºã‚ã‚‹ã‚ˆã€‚",
   "tips":[
    {"type":"usage","en":"on second thought","ja":"ã€Œè€ƒãˆç›´ã—ã¦ã€ã‚„ã£ã±ã‚Šã€ã€‚ä¸€åº¦æ±ºã‚ãŸã“ã¨ã‚„è¨€ã£ãŸã“ã¨ã‚’å¤‰æ›´ã™ã‚‹ã¨ãã«ä½¿ã†ä¾¿åˆ©ãªè¡¨ç¾ã§ã™ã€‚"},
    {"type":"synonym","en":"lay out = spend","ja":"ã€Œï¼ˆå¤§é‡‘ï¼‰ã‚’ã¤ãè¾¼ã‚€ã€ä½¿ã†ã€ã€‚ç‰¹ã«å¤šé¡ã®ãŠé‡‘ã‚’ä½¿ã†å ´åˆã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚"}
   ],
   "headwords":[
    {"en":"lay out", "ja":"ï¼ˆå¤§é‡‘ï¼‰ã‚’ã¤ãè¾¼ã‚€"},
    {"en":"on second thought", "ja":"è€ƒãˆç›´ã—ã¦"},
    {"en":"decide", "ja":"ï½ã‚’æ±ºå¿ƒã™ã‚‹"},
    {"en":"put aside", "ja":"ï½ã‚’å–ã£ã¦ãŠã"},
    {"en":"for a rainy day", "ja":"ã¾ã•ã‹ã®æ™‚ã®ãŸã‚ã«"}
   ]
  }
 ]
}</script>

    <script>
/* ====== æ°¸ç¶šåŒ–ã‚­ãƒ¼ ====== */
const KEY='duo3_progress_v1';
const MODE_KEY='duo3_mode';
const ORI_KEY='duo3_ori_unified';
const HINT_CARDS='duo3_hint_cards_unified';
const VOICE_MODE='duo3_voice_mode_unified';

let reviewQueue = [];
let reviewIndex = 0;

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & SRS ====== */
function getMode(){return localStorage.getItem(MODE_KEY)||'standard';}
function setMode(v){localStorage.setItem(MODE_KEY,v);}
function loadProgress(){try{return JSON.parse(localStorage.getItem(KEY))||{cards:{}}}catch(e){return{cards:{}}}}
function saveProgress(p){localStorage.setItem(KEY,JSON.stringify(p));}
function isDue(c){return !c||!c.next_due||Date.now()>=c.next_due;}
function tomorrowPlusDays(n=0){const d=new Date();const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1);return t.getTime()+n*86400000;}
function markWrong(id){const p=loadProgress();const c=p.cards[id]??={};c.last_result='wrong';c.interval=0;c.next_due=Date.now()-1;p.cards[id]=c;saveProgress(p);}
function markCorrect(id){const p=loadProgress();const c=p.cards[id]??={};c.last_result='correct';const iv=c.interval||0;const next=iv===0?1:iv===1?3:Math.min(iv*2,30);c.interval=next;c.next_due=tomorrowPlusDays(next);c.done=true;p.cards[id]=c;saveProgress(p);}
const DATA_JSON = JSON.parse(document.getElementById('unit-data').textContent);
const DATA = { [DATA_JSON.unit]: DATA_JSON };


/* ====== ãƒã‚¹ã‚¯ï¼ˆãƒ’ãƒ³ãƒˆï¼‰ ====== */
function maskWordSegment(seg){if(seg.length<=1)return seg;return seg[0]+'â€¢'.repeat(seg.length-1);}
function maskToken(token){let out='',buf='';const flush=()=>{if(buf){out+=maskWordSegment(buf);buf='';}};for(const ch of token){if(/[A-Za-z0-9]/.test(ch)){buf+=ch}else{flush();out+=ch}}flush();return out;}
function maskPhrase(s){return s.split(' ').map(maskToken).join(' ');}

/* ====== å‘ããƒ»ãƒ’ãƒ³ãƒˆ ====== */
function getOri(){return localStorage.getItem(ORI_KEY)||'en2ja'}
function setOri(v){localStorage.setItem(ORI_KEY,v)}
function getHintPref(){ return (localStorage.getItem(HINT_CARDS) || 'on') === 'on'; }
function setHintPref(on){ localStorage.setItem(HINT_CARDS, on ? 'on' : 'off'); }

/* ====== TTSï¼ˆéŸ³å£°åˆæˆï¼‰ ====== */
const PAUSE_MS = 1000;
let speechSynthesis = window.speechSynthesis;
let voiceCache = { male: null, female: null, auto: [], toggle: 0 };

function pickVoices() {
    try {
        const vs = speechSynthesis.getVoices();
        if (!vs.length) return;
        const en = vs.filter(v => /^en([-_]|$)/i.test(v.lang) || /english/i.test(v.name));
        voiceCache.female = en.find(v => /female|jenny|ariel|emma|olivia|zira|samantha|alloy|nova/i.test(v.name)) || null;
        voiceCache.male = en.find(v => /male|david|guy|ryan|brian|matthew|daniel|andrew|roger/i.test(v.name)) || null;
        const autoVoiceSet = new Set();
        if (voiceCache.male) autoVoiceSet.add(voiceCache.male);
        if (voiceCache.female) autoVoiceSet.add(voiceCache.female);
        const usUkVoices = en.filter(v => v.lang.startsWith('en-US') || v.lang.startsWith('en-GB'));
        usUkVoices.forEach(v => autoVoiceSet.add(v));
        const otherVoices = en.filter(v => !v.lang.startsWith('en-US') && !v.lang.startsWith('en-GB'));
        otherVoices.forEach(v => autoVoiceSet.add(v));
        voiceCache.auto = Array.from(autoVoiceSet).sort(() => 0.5 - Math.random());
        if (!voiceCache.male) voiceCache.male = voiceCache.auto[0] || en[0] || vs[0];
        if (!voiceCache.female) voiceCache.female = voiceCache.auto[1] || voiceCache.auto[0] || en[0] || vs[0];
    } catch (e) { console.error('Error picking voices', e); }
}

if('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = pickVoices;
  pickVoices();
}

function sanitizeForTTS(s){
    if (!s) return s;
    let t = s.replace(/\([^)]*\)/g, '').replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '');
    t = t.replace(/<[^>]+>/g, '');
    t = t.replace(/[â†”â†®â†’â€”â€“â€¦\/ï½œâ‰ =]/g, ' [[PAUSE]] ');
    t = t.replace(/(\s*\[\[PAUSE\]\]\s*){2,}/g, ' [[PAUSE]] ');
    t = t.replace(/[\u3040-\u30FF\u3400-\u9FFF\uF900-\uFAFF]/g, '');
    t = t.replace(/\s{2,}/g, ' ').trim();
    return t;
}

function getVoiceMode(){return localStorage.getItem(VOICE_MODE)||'auto'}

function speak(text){
    if (!('speechSynthesis' in window) || !text) return;
    try { speechSynthesis.cancel(); } catch (e) { }
    const prepared = sanitizeForTTS(text);
    const parts = prepared.split(/\s*\[\[PAUSE\]\]\s*/).map(s => s.trim()).filter(Boolean);
    if (parts.length === 0) return;
    const rate = parseFloat(document.getElementById('rate')?.value || '1');
    const mode = getVoiceMode();
    const pickVoiceForPart = () => {
        let voiceToUse = null;
        if (mode === 'male') { voiceToUse = voiceCache.male; }
        else if (mode === 'female') { voiceToUse = voiceCache.female; }
        else {
            if (voiceCache.auto.length > 0) {
                voiceCache.toggle = (voiceCache.toggle + 1) % voiceCache.auto.length;
                voiceToUse = voiceCache.auto[voiceCache.toggle];
            }
        }
        if (!voiceToUse) {
            const allVoices = speechSynthesis.getVoices();
            voiceToUse = allVoices.find(v => v.lang.startsWith('en')) || allVoices[0];
        }
        return voiceToUse;
    };
    let partIndex = 0;
    const speakNextPart = () => {
        if (partIndex >= parts.length) return;
        const u = new SpeechSynthesisUtterance(parts[partIndex]);
        u.lang = 'en-US';
        u.rate = rate;
        u.voice = pickVoiceForPart();
        u.onend = () => {
            partIndex++;
            if (partIndex < parts.length) { setTimeout(speakNextPart, PAUSE_MS); }
        };
        if (speechSynthesis.getVoices().length === 0) { setTimeout(() => speechSynthesis.speak(u), 250); }
        else { speechSynthesis.speak(u); }
    };
    speakNextPart();
}

/* ====== UI åŒæœŸ ====== */
function syncAppSettings(){
    const voiceSeg=document.getElementById('voiceSeg');
    if(voiceSeg) [...voiceSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('on',b.dataset.v===getVoiceMode()));
    
    const modeSeg=document.getElementById('modeSeg');
    if(modeSeg) [...modeSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('on',b.dataset.v===getMode()));

    const oriSeg=document.getElementById('oriSeg');
    if(oriSeg) [...oriSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('on',b.dataset.v===getOri()));

    const hintSeg=document.getElementById('hintSeg');
    if(hintSeg) {
        const isHintDisabled = getOri() === 'en2ja';
        hintSeg.style.opacity = isHintDisabled ? '0.5' : '1';
        [...hintSeg.querySelectorAll('button')].forEach(b => {
            b.classList.toggle('on', (b.dataset.v === 'on') === getHintPref());
            b.disabled = isHintDisabled;
        });
    }
}

/* ====== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° & ç”»é¢æç”» ====== */
const app=document.getElementById('app');
addEventListener('hashchange',route);
addEventListener('DOMContentLoaded',route);

function route(){
  const h=location.hash||'#/';
  if(h==='#/'||h==='#'){ renderHome(); }
  else if (h === '#/final-check') { renderFinalCheck(); }
  else if (h === '#/review') { renderReview(); }
  else if(h.startsWith('#play=')){
      const s=h.slice(6);
      const[unit,qs]=s.split('?');
      const params=new URLSearchParams(qs||'');
      const i=parseInt(params.get('i')||'0',10)||0;
      const step=params.get('step')||'quiz';
      renderPlay(unit,i,step);
  }
  else { renderHome(); }
}

/* ====== ãƒ˜ãƒƒãƒ€ãƒ¼ ====== */
document.getElementById('reset-data-btn').onclick=()=>{if(confirm('æœ¬å½“ã«å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){localStorage.removeItem(KEY);alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');location.reload();}}
document.getElementById('header-review-link').onclick = (e) => {
    e.preventDefault();
    location.hash = '#/review';
}

function getDueBreakdown(){
  const p=loadProgress();let total=0,urgent=0,scheduled=0,mcq=0,voc=0;
  for(const id in p.cards){
      const c=p.cards[id];
      if(isDue(c)){
          total++;
          if(c.last_result==='wrong') urgent++; else scheduled++;
          if (id.endsWith('-mcq')) mcq++; else voc++;
      }
  }
  return {total,urgent,scheduled,mcq,voc};
}

function renderHome(){
  const unitId = DATA_JSON.unit;
  const unitTitle = DATA_JSON.title;
  document.getElementById('header-title').textContent = `DUO 3.0 Helper â€” ${unitTitle}`;
  const unit=DATA[unitId];
  
  app.innerHTML=`
    <div id="toc-screen">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-2">${unit.title}</h1>
        <p class="text-gray-600 text-center mb-6">å­¦ç¿’ã—ãŸã„ä¾‹æ–‡ã‚’é¸ã¶ã‹ã€æœ€åˆã‹ã‚‰å…¨ã¦ã®å•é¡Œã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ã€‚</p>
        <div id="review-banner-container" class="mb-6"></div>
        <div class="flex justify-center items-center gap-x-6 gap-y-4 flex-wrap mb-6 text-sm text-gray-600 border bg-gray-50 p-4 rounded-lg">
            <span class="flex items-center"><i class="fas fa-sliders-h mr-2 text-gray-500"></i><strong>éŸ³å£°ãƒ»è¡¨ç¤ºè¨­å®š</strong></span>
            <span>é€Ÿåº¦: <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1" class="align-middle w-24"></span>
            <span class="flex items-center">å£°:
                <span class="segment ml-2" id="voiceSeg">
                    <button data-v="auto" class="on">è‡ªå‹•</button> <button data-v="male">ç”·</button> <button data-v="female">å¥³</button>
                </span>
            </span>
            <span class="flex items-center">ãƒ¢ãƒ¼ãƒ‰:
                <span class="segment ml-2" id="modeSeg">
                    <button data-v="standard" class="on">æ¨™æº–</button> <button data-v="lite">ç°¡æ˜“</button>
                </span>
            </span>
            <span class="flex items-center">ã‚«ãƒ¼ãƒ‰å‘ã:
                <span class="segment ml-2" id="oriSeg">
                    <button data-v="en2ja" class="on">è‹±â†’æ—¥</button> <button data-v="ja2en">æ—¥â†’è‹±</button>
                </span>
            </span>
            <span class="flex items-center">ãƒ’ãƒ³ãƒˆ(æ—¥â†’è‹±):
                <span class="segment ml-2" id="hintSeg">
                    <button data-v="on" class="on">ON</button> <button data-v="off">OFF</button>
                </span>
            </span>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³å­¦ç¿’ã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-orange-50 border-2 border-orange-100 p-8 rounded-3xl mb-8 shadow-lg">
            <h2 class="text-3xl font-extrabold text-orange-900/80 text-center mb-6">ãƒ¡ã‚¤ãƒ³å­¦ç¿’</h2>
            
            <button id="startAll" class="w-full bg-gradient-to-b from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-8 rounded-full text-xl transition-all transform hover:scale-105 shadow-md hover:shadow-lg mb-8">
                æœ€åˆã‹ã‚‰é †ç•ªã«å…¨ã¦ã®å•é¡Œã‚’ã‚„ã‚‹
            </button>
            
            <h3 class="text-xl font-bold text-gray-700 text-center mb-5">å€‹åˆ¥å­¦ç¿’ãƒ»å¾©ç¿’</h3>
            <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5"></div>
        </div>

        <!-- è…•è©¦ã—ã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-white/60 backdrop-blur-sm border border-gray-200/80 p-8 rounded-3xl shadow-lg">
             <h2 class="text-3xl font-extrabold text-gray-800 text-center mb-6">è…•è©¦ã—</h2>
             <button id="final-check-btn" class="w-full bg-white hover:bg-gray-50 text-gray-800 font-bold py-3 px-6 border-2 border-gray-300 rounded-full transition-all transform hover:scale-105">
                ã¾ã¨ã‚ã¦æœ€çµ‚ãƒã‚§ãƒƒã‚¯
            </button>
        </div>
    </div>`;

  document.getElementById('startAll').onclick=()=>location.hash=`#play=${unitId}?i=0&step=quiz`;
  document.getElementById('final-check-btn').onclick = () => location.hash = '#/final-check';
  
  const settingsChanged = (e, setter) => {
    const v = e.target?.dataset?.v;
    if (v) { setter(v); syncAppSettings(); }
  };
  
  document.getElementById('voiceSeg').addEventListener('click', (e) => { const v = e.target?.dataset?.v; if(v) { localStorage.setItem(VOICE_MODE, v); syncAppSettings(); }});
  document.getElementById('modeSeg').addEventListener('click', (e) => settingsChanged(e, setMode));
  document.getElementById('oriSeg').addEventListener('click', (e) => settingsChanged(e, setOri));
  document.getElementById('hintSeg').addEventListener('click', (e) => { const v = e.target?.dataset?.v; if(v) { setHintPref(v === 'on'); syncAppSettings(); }});

  const breakdown = getDueBreakdown();
  const reviewBannerContainer = document.getElementById('review-banner-container');
  const headerReviewBadge = document.getElementById('header-review-badge');

  if (breakdown.total > 0) {
      reviewBannerContainer.innerHTML = `
          <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg cursor-pointer hover:bg-yellow-200" id="start-review-btn">
              <p class="font-bold">ä»Šæ—¥ã®å¾©ç¿’ãŒã‚ã‚Šã¾ã™ï¼</p>
              <p>æœŸé™ãŒæ¥ãŸã‚«ãƒ¼ãƒ‰ãŒ <span class="font-bold">${breakdown.total}</span> ä»¶ã‚ã‚Šã¾ã™ã€‚ï¼ˆè¦å¾©ç¿’: ${breakdown.urgent}ä»¶ / å†ç¢ºèª: ${breakdown.scheduled}ä»¶ï¼‰</p>
          </div>
      `;
      reviewBannerContainer.querySelector('#start-review-btn').addEventListener('click', () => location.hash = '#/review');
      headerReviewBadge.textContent = breakdown.total;
      headerReviewBadge.classList.remove('hidden');
  } else {
      reviewBannerContainer.innerHTML = '';
      headerReviewBadge.classList.add('hidden');
  }


  const p=loadProgress();
  const grid=document.getElementById('grid');
  unit.sentences.forEach((s,i)=>{
    const a=document.createElement('a');
    a.href=`#play=${unitId}?i=${i}&step=quiz`;
    a.className='bg-white p-4 border border-gray-200 rounded-xl shadow-md text-center font-bold text-gray-800 hover:bg-gray-50 hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 transition-all relative flex flex-col justify-center items-center';
    
    const title = document.createElement('span');
    title.textContent=`ä¾‹æ–‡ ${s.number}`;
    a.appendChild(title);

    const cardMcq = p.cards[`${s.id}-mcq`];
    const dueMcq = cardMcq && isDue(cardMcq);

    const dueVoc = (s.headwords || []).some(hw => {
        const cid = `${unit.unit}-${s.id.split('-')[1]}-${hw.en.toLowerCase().replaceAll(' ','_')}`;
        const cardVoc = p.cards[cid];
        return cardVoc && isDue(cardVoc);
    });

    if (dueMcq || dueVoc) {
        const badgeContainer = document.createElement('div');
        badgeContainer.className = 'absolute top-1 right-1 flex space-x-1';
        if (dueMcq) {
            const b = document.createElement('span');
            b.className = 'text-xs bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center font-bold';
            b.textContent = 'Q';
            badgeContainer.appendChild(b);
        }
        if (dueVoc) {
            const b = document.createElement('span');
            b.className = 'text-xs bg-sky-500 text-white rounded-full h-5 w-5 flex items-center justify-center font-bold';
            b.textContent = 'V';
            badgeContainer.appendChild(b);
        }
        a.appendChild(badgeContainer);
    }
    grid.appendChild(a);
  });
  
  syncAppSettings();
}

function renderFinalCheck() {
    document.getElementById('header-title').textContent = 'ã¾ã¨ã‚ã¦æœ€çµ‚ãƒã‚§ãƒƒã‚¯';
    app.innerHTML = `
        <div class="flex justify-between items-center mb-4">
             <a href="#/" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>ç›®æ¬¡ã«æˆ»ã‚‹</a>
             <button id="shuffle-final-check-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-random mr-2"></i>é †ç•ªã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">ã¾ã¨ã‚ã¦æœ€çµ‚ãƒã‚§ãƒƒã‚¯</h2>
        <p id="final-check-description" class="text-sm text-gray-500 text-center mb-6"></p>
        <div id="final-check-flashcards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    `;
    document.getElementById('shuffle-final-check-btn').onclick = renderFinalCheck;
    const allHeadwords = Object.values(DATA).flatMap(unit => unit.sentences.flatMap(s => s.headwords.map(hw => ({ ...hw, sentenceId: s.id, unitId: unit.unit })))).sort(() => Math.random() - 0.5);
    renderGenericFlashcards(document.getElementById('final-check-flashcards'), allHeadwords);
}

function getDueCards() {
    const p = loadProgress();
    const due = [];
    for (const id in p.cards) {
        if (isDue(p.cards[id])) {
            const cardData = { id, progress: p.cards[id] };
            const parts = id.split('-');
            const unitId = parts[0];
            const sentenceId = `${parts[0]}-${parts[1]}`;
            
            const unit = DATA[unitId];
            if (!unit) continue;

            const sentence = unit.sentences.find(s => s.id === sentenceId);
            if (!sentence) continue;
            
            if (id.endsWith('-mcq')) {
                cardData.type = 'mcq';
                cardData.mcq = sentence.mcq;
                cardData.ja = sentence.ja;
            } else {
                const enWord = parts.slice(2).join(' ').replaceAll('_', ' ');
                const headword = sentence.headwords.find(hw => hw.en.toLowerCase().replace(/ /g, '_') === enWord.replace(/ /g, '_'));
                if (headword) {
                    cardData.type = 'voc';
                    cardData.hw = headword;
                }
            }

            if(cardData.type){
                due.push(cardData);
            }
        }
    }
    due.sort((a, b) => {
        if (a.progress.last_result === 'wrong' && b.progress.last_result !== 'wrong') return -1;
        if (a.progress.last_result !== 'wrong' && b.progress.last_result === 'wrong') return 1;
        return (a.progress.next_due || 0) - (b.progress.next_due || 0);
    });
    return due;
}


function renderReview() {
    document.getElementById('header-title').textContent = 'ä»Šæ—¥ã®å¾©ç¿’';
    reviewQueue = getDueCards();
    reviewIndex = 0;

    app.innerHTML = `
        <div class="flex justify-between items-center mb-4">
             <a href="#/" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>ç›®æ¬¡ã«æˆ»ã‚‹</a>
             <div id="review-progress" class="text-gray-500 font-medium"></div>
        </div>
        <div id="review-card-container"></div>
        <div id="review-complete" class="hidden text-center p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">å¾©ç¿’å®Œäº†ï¼</h2>
            <p class="text-gray-600 mb-6">ä»Šæ—¥ã®å¾©ç¿’ã¯ã™ã¹ã¦çµ‚ã‚ã‚Šã¾ã—ãŸã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</p>
            <a href="#/" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full">ç›®æ¬¡ã«æˆ»ã‚‹</a>
        </div>
    `;

    if (reviewQueue.length > 0) {
        renderNextReviewCard();
    } else {
        document.getElementById('review-card-container').innerHTML = `<p class="text-center text-gray-500 py-8">ä»Šæ—¥ã®å¾©ç¿’é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        document.getElementById('review-progress').textContent = '0 / 0';
    }
}

function renderNextReviewCard() {
    if (reviewIndex >= reviewQueue.length) {
        document.getElementById('review-card-container').classList.add('hidden');
        document.getElementById('review-complete').classList.remove('hidden');
        document.getElementById('review-progress').textContent = `å®Œäº† (${reviewQueue.length}/${reviewQueue.length})`;
        return;
    }
    
    document.getElementById('review-progress').textContent = `é€²æ—: ${reviewIndex + 1} / ${reviewQueue.length}`;
    
    const cardData = reviewQueue[reviewIndex];
    const container = document.getElementById('review-card-container');
    container.innerHTML = ''; // Clear previous card

    if (cardData.type === 'mcq') {
        renderReviewMcqCard(container, cardData);
    } else if (cardData.type === 'voc') {
        renderReviewVocCard(container, cardData);
    } else {
        // Skip unknown card types
        reviewIndex++;
        renderNextReviewCard();
    }
}

function handleReviewAction(isCorrect) {
    const cardData = reviewQueue[reviewIndex];
    if (isCorrect) {
        markCorrect(cardData.id);
    } else {
        markWrong(cardData.id);
    }
    reviewIndex++;
    setTimeout(renderNextReviewCard, isCorrect ? 400 : 800);
}

function renderReviewMcqCard(container, cardData) {
    const { mcq, ja } = cardData;
    const shuffledChoices = [mcq.answer, ...mcq.distractors].sort(() => Math.random() - 0.5);
    let optionsHTML = shuffledChoices.map(choice =>
        `<button class="btn-option w-full p-4 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium transition-all duration-200 hover:border-blue-500 hover:shadow-md">${choice}</button>`
    ).join('');

    container.innerHTML = `
        <div class="p-4 border rounded-lg shadow-sm">
            <p class="text-sm text-gray-500 text-center mb-4">ç©ºæ‰€è£œå……</p>
            <div class="mb-6 relative">
                <p class="text-xl md:text-2xl text-gray-800 text-center p-4 bg-gray-50 rounded-lg">${mcq.stem_en}</p>
                <button class="absolute top-2 right-2 text-gray-500 hover:text-blue-500 text-lg" onclick="speak('${mcq.stem_en.replace('[____]', mcq.answer).replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
            </div>
            <div id="review-quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHTML}</div>
            <div id="review-quiz-feedback" class="p-4 rounded-lg text-center font-medium hidden my-4"></div>
        </div>
    `;

    container.querySelector('#review-quiz-options').addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON' || e.target.disabled) return;
        
        const selectedButton = e.target;
        const isCorrect = selectedButton.textContent === mcq.answer;
        
        container.querySelectorAll('#review-quiz-options button').forEach(button => {
            button.disabled = true;
            if (button.textContent === mcq.answer) button.classList.add('bg-green-200', 'border-green-500');
            else if (button === selectedButton) button.classList.add('bg-red-200', 'border-red-500');
        });
        
        const feedbackEl = container.querySelector('#review-quiz-feedback');
        feedbackEl.innerHTML = isCorrect ? `<span class="font-bold text-green-700">æ­£è§£ï¼</span>` : `<span class="font-bold text-red-700">ä¸æ­£è§£ã€‚</span> æ­£è§£ã¯ <b>${mcq.answer}</b> ã§ã™ã€‚`;
        feedbackEl.innerHTML += `<p class="text-gray-600 mt-2">è¨³ï¼š${ja}</p>`;
        feedbackEl.className = `p-4 rounded-lg text-center font-medium my-4 ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`;
        feedbackEl.classList.remove('hidden');

        handleReviewAction(isCorrect);
    });
}

function renderReviewVocCard(container, cardData) {
    const { hw, id } = cardData;
    const ori = getOri();
    const hintOn = getHintPref();

    const frontMain = (ori === 'en2ja') ? hw.en : hw.ja;
    const frontSub = (ori === 'en2ja') ? (hw.pos || '') : (hintOn ? `ãƒ’ãƒ³ãƒˆ: ${maskPhrase(hw.en)}` : '');
    const backMain = (ori === 'en2ja') ? hw.ja : `${hw.en}${hw.pos ? ` <small class="text-base text-gray-500">/ ${hw.pos}</small>` : ''}`;
    
    container.innerHTML = `
        <div class="card-wrapper flex flex-col gap-2">
            <div class="flashcard h-48 relative">
                <div class="flashcard-inner">
                    <div class="flashcard-front"><div class="text-center">
                        <strong class="text-2xl font-bold text-gray-800">${frontMain}</strong>
                        ${frontSub ? `<br><small class="text-gray-500 mt-1">${frontSub}</small>` : ''}
                    </div><button class="speaker-btn" onclick="event.stopPropagation(); speak('${hw.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button></div>
                    <div class="flashcard-back"><div class="text-center">
                        <strong class="text-2xl font-bold text-gray-800">${backMain}</strong>
                    </div><button class="speaker-btn" onclick="event.stopPropagation(); speak('${hw.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button></div>
                </div>
            </div>
            <div id="review-voc-actions" class="grid grid-cols-2 gap-2 hidden mt-2">
                <button data-action="mark-wrong" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">ã‚ã¨ã§å¾©ç¿’</button>
                <button data-action="mark-correct" class="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">ã§ããŸ</button>
            </div>
        </div>
    `;

    const flashcard = container.querySelector('.flashcard');
    const actions = container.querySelector('#review-voc-actions');

    flashcard.addEventListener('click', () => {
        if (flashcard.classList.contains('flipped')) return;
        flashcard.classList.add('flipped');
        actions.classList.remove('hidden');
    });

    actions.addEventListener('click', e => {
        const action = e.target.closest('[data-action]')?.dataset.action;
        if (!action) return;
        
        if (action === 'mark-correct') {
            handleReviewAction(true);
        } else if (action === 'mark-wrong') {
            handleReviewAction(false);
        }
    });
}

function renderGenericFlashcards(container, cards) {
    container.innerHTML = '';
    const progress = loadProgress();
    const ori = getOri();
    const hintOn = getHintPref();
    cards.forEach(card => {
        const cid = `${card.unitId}-${card.sentenceId.split('-')[1]}-${card.en.toLowerCase().replaceAll(' ','_')}`;
        const cardProgress = progress.cards[cid];
        const cardEl = document.createElement('div');
        cardEl.className = 'flex flex-col gap-2';
        const flashcardDiv = document.createElement('div');
        flashcardDiv.className = 'flashcard h-48 relative'; 
        let statusBadgeHTML = '';
        if (cardProgress && isDue(cardProgress) && cardProgress.last_result === 'wrong') { statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full z-10">è¦å¾©ç¿’</span>'; }
        else if (cardProgress && isDue(cardProgress)) { statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full z-10">å†ç¢ºèª</span>'; }
        else if (cardProgress && cardProgress.done) { statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full z-10">ã§ããŸ</span>'; }
        const frontMain = (ori === 'en2ja') ? card.en : card.ja;
        const frontSub = (ori === 'en2ja') ? (card.pos || '') : (hintOn ? `ãƒ’ãƒ³ãƒˆ: ${maskPhrase(card.en)}` : '');
        const backMain = (ori === 'en2ja') ? card.ja : `${card.en}${card.pos ? ` / <small>${card.pos}</small>` : ''}`;
        flashcardDiv.innerHTML = `${statusBadgeHTML}<div class="flashcard-inner" style="min-height: 120px;"><div class="flashcard-front text-center"><strong class="text-2xl">${frontMain}</strong>${frontSub ? `<br><small class="text-gray-500">${frontSub}</small>`: ''}<button class="speaker-btn"><i class="fas fa-volume-up"></i></button></div><div class="flashcard-back text-center"><strong class="text-2xl">${backMain}</strong><button class="speaker-btn"><i class="fas fa-volume-up"></i></button></div></div>`;
        flashcardDiv.addEventListener('click', () => flashcardDiv.classList.toggle('flipped'));
        flashcardDiv.querySelectorAll('.speaker-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); speak(card.en); }); });
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'grid grid-cols-2 gap-2';
        const correctBtn = document.createElement('button');
        correctBtn.textContent = 'ã§ããŸ';
        correctBtn.className = 'w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors';
        correctBtn.onclick = (e) => { e.stopPropagation(); markCorrect(cid); renderGenericFlashcards(container, cards); };
        const wrongBtn = document.createElement('button');
        wrongBtn.textContent = 'ã‚ã¨ã§å¾©ç¿’';
        wrongBtn.className = 'w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors';
        wrongBtn.onclick = (e) => { e.stopPropagation(); markWrong(cid); renderGenericFlashcards(container, cards); };
        buttonContainer.append(wrongBtn, correctBtn);
        cardEl.append(flashcardDiv, buttonContainer);
        container.appendChild(cardEl);
    });
}

function svg(name){
  const e = {'collocation':'<span class="tip-emoji">ğŸ”—</span>','paraphrase':'<span class="tip-emoji">ğŸ”</span>','synonym':'<span class="tip-emoji">â‰ˆ</span>','antonym':'<span class="tip-emoji">â‡„</span>','usage':'<span class="tip-emoji">ğŸ’¡</span>','dialog':'<span class="tip-emoji">ğŸ’¬</span>'};
  return e[name]||'';
}

function renderPlay(unitId,idx,step){
  const unit=DATA[unitId]; const s=unit.sentences[idx]; if(!s){app.textContent='ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';return;}
  document.getElementById('header-title').textContent = `ä¾‹æ–‡ ${s.number}`;
  app.innerHTML = `
    <div id="main-quiz-area">
        <div class="flex justify-between items-center mb-2">
            <a href="#/" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>ç›®æ¬¡ã«æˆ»ã‚‹</a>
            <p class="text-gray-500 font-medium">ä¾‹æ–‡ ${s.number}/${unit.sentences[unit.sentences.length-1].number}</p>
        </div>
        <div class="flex justify-center space-x-1 md:space-x-2 mb-6 text-xs md:text-sm" id="step-indicators-container">
            <a href="#play=${unitId}?i=${idx}&step=quiz" data-step="quiz" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">1:ã‚¯ã‚¤ã‚º</a>
            ${getMode() !== 'lite' ? `<a href="#play=${unitId}?i=${idx}&step=tips" data-step="tips" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">2:å¿œç”¨</a>` : ''}
            <a href="#play=${unitId}?i=${idx}&step=cards" data-step="cards" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">3:å˜èªã‚«ãƒ¼ãƒ‰</a>
        </div>
        <div id="step-views">
            <div id="step-quiz"></div> <div id="step-tips" class="hidden"></div> <div id="step-cards" class="hidden"></div>
        </div>
        <div id="sentence-nav" class="flex justify-between mt-4 pt-4 border-t">
            <a id="prev-sentence-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-chevron-left mr-2"></i>å‰ã®ä¾‹æ–‡</a>
            <a id="next-sentence-btn" class="text-blue-500 hover:text-blue-700 font-semibold">æ¬¡ã®ä¾‹æ–‡<i class="fas fa-chevron-right ml-2"></i></a>
        </div>
    </div>`;
  const prevBtn = document.getElementById('prev-sentence-btn');
  const nextBtn = document.getElementById('next-sentence-btn');
  if (idx > 0) { prevBtn.href = `#play=${unitId}?i=${idx-1}&step=quiz`; }
  else { prevBtn.classList.add('opacity-50', 'cursor-not-allowed'); prevBtn.onclick = (e) => e.preventDefault(); }
  if (idx < unit.sentences.length - 1) { nextBtn.href = `#play=${unitId}?i=${idx+1}&step=quiz`; }
  else { nextBtn.classList.add('opacity-50', 'cursor-not-allowed'); nextBtn.onclick = (e) => e.preventDefault(); }
  const stepViews = {quiz: document.getElementById('step-quiz'), tips: document.getElementById('step-tips'), cards: document.getElementById('step-cards')};
  Object.values(stepViews).forEach(v => v && v.classList.add('hidden'));
  const currentStepView = stepViews[step];
  if (currentStepView) {
      currentStepView.classList.remove('hidden');
      const activeIndicator = document.querySelector(`.step-indicator[data-step="${step}"]`);
      if(activeIndicator) activeIndicator.classList.add('bg-blue-500', 'text-white', 'font-bold');
  }
  if (step === 'quiz') renderQuiz(stepViews.quiz, unit, s, idx);
  else if (step === 'tips' && getMode() !== 'lite') renderTips(stepViews.tips, unit, s, idx);
  else if (step === 'cards') renderCards(stepViews.cards, unit, s, idx);
}

function renderQuiz(container, unit, sentence, idx) {
    const { mcq, ja } = sentence;
    const shuffledChoices = [mcq.answer, ...mcq.distractors].sort(() => Math.random() - 0.5);
    let optionsHTML = shuffledChoices.map(choice =>
        `<button class="btn-option w-full p-4 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium transition-all duration-200 hover:border-blue-500 hover:shadow-md">${choice}</button>`
    ).join('');
    container.innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">ã‚ã¦ã¯ã¾ã‚‹é¸æŠè‚¢ã‚’é¸ã³ã¾ã—ã‚‡ã†ã€‚</p>
        <div class="mb-6 relative">
            <p class="text-xl md:text-2xl text-gray-800 text-left p-4 bg-gray-50 rounded-lg">${mcq.stem_en}</p>
            <button class="speaker-btn text-xl" onclick="speak('${mcq.stem_en.replace('[____]', mcq.answer).replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
        </div>
        <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHTML}</div>
        <div id="quiz-feedback" class="p-4 rounded-lg text-center font-medium hidden my-4"></div>
        <div id="quiz-nav" class="text-center mt-6 hidden"></div>
    `;
    container.querySelector('#quiz-options').addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;
        const selectedButton = e.target;
        const isCorrect = selectedButton.textContent === mcq.answer;
        const itemId = `${sentence.id}-mcq`;
        if (isCorrect) markCorrect(itemId); else markWrong(itemId);
        const feedbackEl = container.querySelector('#quiz-feedback');
        feedbackEl.innerHTML = isCorrect
            ? `<span class="font-bold text-green-700">æ­£è§£ï¼</span>`
            : `<span class="font-bold text-red-700">ä¸æ­£è§£ã€‚</span> æ­£è§£ã¯ <b>${mcq.answer}</b> ã§ã™ã€‚`;
        feedbackEl.innerHTML += `<p class="text-gray-600 mt-2">è¨³ï¼š${ja}</p>`;
        feedbackEl.className = `p-4 rounded-lg text-center font-medium my-4 ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`;
        feedbackEl.classList.remove('hidden');
        container.querySelectorAll('#quiz-options button').forEach(button => {
            button.disabled = true;
            if (button.textContent === mcq.answer) button.classList.add('bg-green-200', 'border-green-500');
            else if (button === selectedButton) button.classList.add('bg-red-200', 'border-red-500');
        });
        const quizNav = container.querySelector('#quiz-nav');
        const nextStep = (getMode() !== 'lite' && sentence.tips && sentence.tips.length > 0) ? 'tips' : 'cards';
        quizNav.innerHTML = `<a href="#play=${unit.unit}?i=${idx}&step=${nextStep}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors">æ¬¡ã¸</a>`;
        quizNav.classList.remove('hidden');
    });
}
function renderTips(container, unit, sentence, idx) {
    const { tips } = sentence;
    const labels={'collocation':{title:'ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', icon:svg('collocation')}, 'paraphrase':{title:'è¨€ã„æ›ãˆ', icon:svg('paraphrase')}, 'synonym':{title:'é¡ç¾©èª', icon:svg('synonym')}, 'antonym':{title:'å¯¾ç¾©èª', icon:svg('antonym')}, 'usage':{title:'ç”¨æ³•', icon:svg('usage')}, 'dialog':{title:'ä¼šè©±ä¾‹', icon:svg('dialog')}};
    const order=['collocation','paraphrase','synonym','antonym','usage','dialog'];
    if (!tips || tips.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500">ã“ã®ä¾‹æ–‡ã®å¿œç”¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
    } else {
        const groups={}; tips.forEach(t=>{(groups[t.type]=groups[t.type]||[]).push(t);});
        let html = '';
        order.forEach(key => {
            if (!groups[key]) return;
            html += `<h4 class="text-md font-bold text-gray-700 mt-6 mb-2 flex items-center">${labels[key].icon} <span class="ml-2">${labels[key].title}</span></h4>`;
            groups[key].forEach(t => {
                html += `
                    <div class="tip-item flex items-center p-3 border rounded-lg bg-white mb-2">
                        <div>
                            <span class="font-semibold text-gray-800">${t.en}</span><span class="text-gray-600"> â€” ${t.ja}</span>
                        </div>
                        <button onclick="speak('${(t.tts || t.en).replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/`/g, '\\`')}')" class="ml-auto flex-shrink-0 p-2 text-gray-400 hover:text-blue-500 text-xl"><i class="fas fa-volume-up"></i></button>
                    </div>`;
            });
        });
        container.innerHTML = html;
    }
    const quizNav = document.createElement('div');
    quizNav.className = 'text-center mt-6';
    quizNav.innerHTML = `<a href="#play=${unit.unit}?i=${idx}&step=cards" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors">å˜èªã‚«ãƒ¼ãƒ‰ã¸</a>`;
    container.appendChild(quizNav);
}
function renderCards(container, unit, sentence, idx) {
    let topChipsHTML = `
        <div class="toprow flex items-center justify-center gap-4 mb-6 text-sm">
            <span class="chip flex items-center p-2 border rounded-full bg-gray-50">
                å‘ã: <b class="mx-1">${getOri() === 'en2ja' ? 'è‹±â†’æ—¥' : 'æ—¥â†’è‹±'}</b>
                <button class="text-blue-500 ml-1 font-semibold" data-action="toggle-ori">å¤‰æ›´</button>
            </span>`;
    if (getOri() === 'ja2en') {
        topChipsHTML += `
            <span class="chip flex items-center p-2 border rounded-full bg-gray-50">
                ãƒ’ãƒ³ãƒˆ: <b class="mx-1">${getHintPref() ? 'ON' : 'OFF'}</b>
                <button class="text-blue-500 ml-1 font-semibold" data-action="toggle-hint">åˆ‡æ›¿</button>
            </span>`;
    }
    topChipsHTML += '</div>';
    container.innerHTML = topChipsHTML + '<div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>';
    renderSentenceFlashcards(container.querySelector('#cards-container'), unit, sentence);
    container.addEventListener('click', e => {
        const action = e.target.dataset.action;
        if (action === 'toggle-ori') { setOri(getOri() === 'en2ja' ? 'ja2en' : 'en2ja'); route(); }
        if (action === 'toggle-hint') { setHintPref(!getHintPref()); route(); }
    });
    const navDiv = document.createElement('div');
    navDiv.className = 'text-center mt-6';
    const nextSentenceIdx = idx + 1;
    const navLink = (nextSentenceIdx < unit.sentences.length) ? `#play=${unit.unit}?i=${nextSentenceIdx}&step=quiz` : '#/';
    const navText = (nextSentenceIdx < unit.sentences.length) ? 'æ¬¡ã®ä¾‹æ–‡ã¸' : 'ç›®æ¬¡ã«æˆ»ã‚‹';
    navDiv.innerHTML = `<a href="${navLink}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors">${navText}</a>`;
    container.appendChild(navDiv);
}
function renderSentenceFlashcards(container, unit, sentence) {
    const { headwords } = sentence;
    const ori = getOri();
    const hintOn = getHintPref();
    const progress = loadProgress();
    container.innerHTML = headwords.map(hw => {
        const cid = `${unit.unit}-${sentence.id.split('-')[1]}-${hw.en.toLowerCase().replaceAll(' ','_')}`;
        const p = progress.cards[cid];
        let statusBadgeHTML = '';
        if (p && isDue(p) && p.last_result === 'wrong') statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full z-10">è¦å¾©ç¿’</span>';
        else if (p && isDue(p)) statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full z-10">å†ç¢ºèª</span>';
        else if (p && p.done) statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full z-10">ã§ããŸ</span>';
        const frontMain = (ori === 'en2ja') ? hw.en : hw.ja;
        const frontMainClass = (ori === 'en2ja') ? 'text-2xl' : 'text-xl';
        const backMainClass = (ori === 'en2ja') ? 'text-xl' : 'text-2xl';
        const frontSub = (ori === 'en2ja') ? (hw.pos || '') : (hintOn ? `ãƒ’ãƒ³ãƒˆ: ${maskPhrase(hw.en)}` : '');
        const backMain = (ori === 'en2ja') ? hw.ja : `${hw.en}${hw.pos ? ` <small class="text-base text-gray-500">/ ${hw.pos}</small>` : ''}`;
        return `
            <div class="card-wrapper flex flex-col gap-2" data-cid="${cid}">
                <div class="flashcard h-48 relative">
                    ${statusBadgeHTML}
                    <div class="flashcard-inner">
                        <div class="flashcard-front"><div class="text-center">
                            <strong class="${frontMainClass} font-bold text-gray-800">${frontMain}</strong>
                            ${frontSub ? `<br><small class="text-gray-500 mt-1">${frontSub}</small>` : ''}
                        </div><button class="speaker-btn" data-action="speak" data-text="${hw.en.replace(/'/g, "\\'")}"><i class="fas fa-volume-up"></i></button></div>
                        <div class="flashcard-back"><div class="text-center">
                            <strong class="${backMainClass} font-bold text-gray-800">${backMain}</strong>
                        </div><button class="speaker-btn" data-action="speak" data-text="${hw.en.replace(/'/g, "\\'")}"><i class="fas fa-volume-up"></i></button></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button data-action="mark-wrong" class="w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">ã‚ã¨ã§å¾©ç¿’</button>
                    <button data-action="mark-correct" class="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">ã§ããŸ</button>
                </div>
            </div>`;
    }).join('');
    container.addEventListener('click', e => {
        const cardWrapper = e.target.closest('.card-wrapper');
        if (!cardWrapper) return;
        const action = e.target.closest('[data-action]')?.dataset.action;
        const cid = cardWrapper.dataset.cid;
        if (action === 'speak') { e.stopPropagation(); speak(e.target.closest('[data-text]').dataset.text); return; }
        if (action === 'mark-wrong') { markWrong(cid); renderSentenceFlashcards(container, unit, sentence); return; }
        if (action === 'mark-correct') { markCorrect(cid); renderSentenceFlashcards(container, unit, sentence); return; }
        const flashcard = cardWrapper.querySelector('.flashcard');
        if (flashcard) flashcard.classList.toggle('flipped');
    });
}

/* ====== æ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœ¬ä½“ ====== */
(function() {
    const main = document.querySelector('main');
    if (main) {
        main.className = 'max-w-5xl mx-auto bg-transparent p-4 md:p-6 mt-4';
    }
})();

</script>
</body>
</html>